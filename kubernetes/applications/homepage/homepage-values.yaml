---
# Homepage Helm Chart Values
# https://github.com/jameswynn/helm-charts/tree/main/charts/homepage
#
# This configures the official Homepage chart with:
# - Kubernetes service discovery via RBAC
# - External ConfigMaps for services, settings, widgets
# - Environment variables for API secrets

# Container image
image:
  repository: ghcr.io/gethomepage/homepage
  tag: latest
  pullPolicy: IfNotPresent

# Enable ServiceAccount with RBAC for Kubernetes discovery
enableRbac: true

serviceAccount:
  create: true
  name: homepage
  annotations: {}

# Resource limits
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi

# Service configuration
service:
  main:
    ports:
      http:
        port: 3000

# Environment variables from secrets
env:
  # Allow requests from custom domain (required for reverse proxy)
  HOMEPAGE_ALLOWED_HOSTS: "home.silverseekers.org"
  # Proxmox API token (from sealed secret)
  HOMEPAGE_VAR_PROXMOX_TOKEN_ID:
    valueFrom:
      secretKeyRef:
        name: homepage-secrets
        key: proxmox-token-id
  HOMEPAGE_VAR_PROXMOX_TOKEN_SECRET:
    valueFrom:
      secretKeyRef:
        name: homepage-secrets
        key: proxmox-token-secret
  # OpenWeatherMap API key (optional)
  HOMEPAGE_VAR_OPENWEATHER_API_KEY:
    valueFrom:
      secretKeyRef:
        name: homepage-secrets
        key: openweather-api-key
        optional: true

# Configuration - mount ConfigMap at different path, use initContainer to copy
# This allows Homepage to write to /app/config while using our config content
config:
  # Use the ConfigMap we create in templates/configmap-complete.yaml
  useExistingConfigMap: homepage-config

# Use emptyDir for /app/config so Homepage can write to it
# The initContainer copies our ConfigMap content to this writable location
persistence:
  config:
    enabled: true
    type: emptyDir
    mountPath: /app/config
  config-source:
    enabled: true
    type: configMap
    name: homepage-config
    mountPath: /config-readonly
  logs:
    enabled: true
    type: emptyDir
    mountPath: /app/config/logs

# Init container to copy config from readonly ConfigMap to writable emptyDir
initContainers:
  copy-config:
    image: busybox:latest
    command:
      - sh
      - -c
      - |
        echo "Copying config files from ConfigMap to writable directory..."
        cp -v /config-readonly/* /app/config/ || true
        ls -la /app/config/
        echo "Config copy complete"
    volumeMounts:
      - name: config-source
        mountPath: /config-readonly
      - name: config
        mountPath: /app/config

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

# Liveness and readiness probes
livenessProbe:
  httpGet:
    path: /api/healthcheck
    port: 3000
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /api/healthcheck
    port: 3000
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3


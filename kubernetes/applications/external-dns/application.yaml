---
# External-DNS ArgoCD Application
# Automated DNS record management for Kubernetes resources
#
# This Application will be auto-discovered by the root app if using app-of-apps pattern
# Alternatively, apply manually: kubectl apply -f application.yaml

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-dns
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  # Multiple sources: Helm chart + values from this repo
  sources:
    # Helm chart from external-dns repository
    - repoURL: https://kubernetes-sigs.github.io/external-dns
      targetRevision: 1.15.0
      chart: external-dns
      helm:
        valueFiles:
          - $values/kubernetes/services/external-dns/values.yaml

    # Values from this repo
    - repoURL: https://github.com/HughLardner/homelab.git
      targetRevision: HEAD
      ref: values

  destination:
    server: https://kubernetes.default.svc
    namespace: external-dns

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  # Health assessment
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas  # Allow HPA to manage replicas if configured

  # Info
  info:
    - name: Documentation
      value: https://github.com/kubernetes-sigs/external-dns
    - name: Local README
      value: kubernetes/services/external-dns/README.md

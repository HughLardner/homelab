---
# =============================================================================
# Grafana MCP Service Account Setup Job
# =============================================================================
# This Job creates a service account in Grafana with an API token
# for use by the mcp-grafana AI assistant integration.
#
# The Job runs after Grafana is ready and uses ArgoCD sync-waves to ensure
# proper ordering.
# =============================================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-mcp-setup-script
  namespace: monitoring
data:
  setup.sh: |
    #!/bin/sh
    set -e

    GRAFANA_URL="${GRAFANA_URL:-http://grafana.monitoring.svc:80}"
    SA_NAME="mcp-grafana"
    TOKEN_NAME="mcp-cursor-token"

    echo "Waiting for Grafana to be ready..."
    until curl -sf "${GRAFANA_URL}/api/health" > /dev/null 2>&1; do
      echo "Grafana not ready, waiting..."
      sleep 5
    done
    echo "Grafana is ready!"

    # Check if service account already exists
    echo "Checking if service account '${SA_NAME}' exists..."
    SA_RESPONSE=$(curl -sf -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
      "${GRAFANA_URL}/api/serviceaccounts/search?query=${SA_NAME}" 2>/dev/null || echo '{"serviceAccounts":[]}')

    SA_ID=$(echo "${SA_RESPONSE}" | sed -n 's/.*"id":\([0-9]*\).*/\1/p' | head -1)

    if [ -z "${SA_ID}" ]; then
      echo "Creating service account '${SA_NAME}'..."
      CREATE_RESPONSE=$(curl -sf -X POST \
        -H "Content-Type: application/json" \
        -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
        -d '{"name":"'"${SA_NAME}"'","role":"Admin","isDisabled":false}' \
        "${GRAFANA_URL}/api/serviceaccounts")

      SA_ID=$(echo "${CREATE_RESPONSE}" | sed -n 's/.*"id":\([0-9]*\).*/\1/p')
      echo "Created service account with ID: ${SA_ID}"
    else
      echo "Service account already exists with ID: ${SA_ID}"
    fi

    # Check if token already exists
    echo "Checking for existing tokens..."
    TOKENS_RESPONSE=$(curl -sf -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
      "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens" 2>/dev/null || echo "[]")

    if echo "${TOKENS_RESPONSE}" | grep -q "\"name\":\"${TOKEN_NAME}\""; then
      echo "=============================================="
      echo "Token already exists!"
      echo "=============================================="
      echo "The token '${TOKEN_NAME}' was created previously."
      echo "Check earlier Job logs for the token value, or"
      echo "delete the service account in Grafana UI and re-run."
      echo ""
      echo "Grafana UI: https://grafana.silverseekers.org/admin/serviceaccounts"
      echo "=============================================="
      exit 0
    fi

    # Create new token - Grafana generates the value
    echo "Creating service account token..."
    TOKEN_RESPONSE=$(curl -sf -X POST \
      -H "Content-Type: application/json" \
      -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
      -d '{"name":"'"${TOKEN_NAME}"'"}' \
      "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens")

    # Extract the generated token
    GENERATED_TOKEN=$(echo "${TOKEN_RESPONSE}" | sed -n 's/.*"key":"\([^"]*\)".*/\1/p')

    if [ -n "${GENERATED_TOKEN}" ]; then
      echo ""
      echo "=============================================="
      echo "SUCCESS! MCP Service Account Token Created"
      echo "=============================================="
      echo ""
      echo "SAVE THIS TOKEN - it cannot be retrieved later!"
      echo ""
      echo "Token: ${GENERATED_TOKEN}"
      echo ""
      echo "=============================================="
      echo "Add to ~/.cursor/mcp.json:"
      echo "=============================================="
      echo '{'
      echo '  "mcpServers": {'
      echo '    "grafana": {'
      echo '      "command": "docker",'
      echo '      "args": ["run", "--rm", "-i", "-e", "GRAFANA_URL", "-e", "GRAFANA_SERVICE_ACCOUNT_TOKEN", "mcp/grafana", "-t", "stdio"],'
      echo '      "env": {'
      echo '        "GRAFANA_URL": "https://grafana.silverseekers.org",'
      echo "        \"GRAFANA_SERVICE_ACCOUNT_TOKEN\": \"${GENERATED_TOKEN}\""
      echo '      }'
      echo '    }'
      echo '  }'
      echo '}'
      echo "=============================================="
    else
      echo "Failed to create token"
      echo "Response: ${TOKEN_RESPONSE}"
      exit 1
    fi

---
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-mcp-setup
  namespace: monitoring
  annotations:
    # Run after Grafana is deployed
    argocd.argoproj.io/sync-wave: "10"
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: curlimages/curl:8.5.0
          command: ["/bin/sh", "/scripts/setup.sh"]
          env:
            - name: GRAFANA_URL
              value: "http://grafana.monitoring.svc:80"
            - name: GF_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: grafana-admin-secret
                  key: admin-user
            - name: GF_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-admin-secret
                  key: admin-password
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: grafana-mcp-setup-script
            defaultMode: 0755

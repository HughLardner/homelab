---
# =============================================================================
# Grafana MCP Service Account Setup Job
# =============================================================================
# This Job creates a service account in Grafana with a fixed API token
# for use by the mcp-grafana AI assistant integration.
#
# The Job runs after Grafana is ready and uses ArgoCD sync-waves to ensure
# proper ordering.
# =============================================================================

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-mcp-setup-script
  namespace: monitoring
data:
  setup.sh: |
    #!/bin/sh
    set -e

    GRAFANA_URL="${GRAFANA_URL:-http://grafana.monitoring.svc:80}"
    SA_NAME="mcp-grafana"
    TOKEN_NAME="mcp-cursor-token"

    echo "Waiting for Grafana to be ready..."
    until curl -sf "${GRAFANA_URL}/api/health" > /dev/null 2>&1; do
      echo "Grafana not ready, waiting..."
      sleep 5
    done
    echo "Grafana is ready!"

    # Check if service account already exists
    echo "Checking if service account '${SA_NAME}' exists..."
    SA_RESPONSE=$(curl -sf -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
      "${GRAFANA_URL}/api/serviceaccounts/search?query=${SA_NAME}" 2>/dev/null || echo '{"serviceAccounts":[]}')

    SA_ID=$(echo "${SA_RESPONSE}" | grep -o '"id":[0-9]*' | head -1 | grep -o '[0-9]*' || echo "")

    if [ -z "${SA_ID}" ]; then
      echo "Creating service account '${SA_NAME}'..."
      CREATE_RESPONSE=$(curl -sf -X POST \
        -H "Content-Type: application/json" \
        -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
        -d "{\"name\":\"${SA_NAME}\",\"role\":\"Admin\",\"isDisabled\":false}" \
        "${GRAFANA_URL}/api/serviceaccounts")

      SA_ID=$(echo "${CREATE_RESPONSE}" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')
      echo "Created service account with ID: ${SA_ID}"
    else
      echo "Service account already exists with ID: ${SA_ID}"
    fi

    # Check if token already exists - if so, don't recreate (token is stable)
    echo "Checking for existing tokens..."
    TOKENS_RESPONSE=$(curl -sf -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
      "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens" 2>/dev/null || echo "[]")

    TOKEN_EXISTS=$(echo "${TOKENS_RESPONSE}" | grep -o "\"name\":\"${TOKEN_NAME}\"" || echo "")

    if [ -n "${TOKEN_EXISTS}" ]; then
      echo "✅ Token '${TOKEN_NAME}' already exists - keeping existing token"
      echo ""
      echo "To get the token value, check the Job logs from when the token was first created,"
      echo "or delete the service account in Grafana UI to regenerate."
      exit 0
    fi

    # Create new token - Grafana generates the value
    echo "Creating service account token..."
    TOKEN_RESPONSE=$(curl -sf -X POST \
      -H "Content-Type: application/json" \
      -u "${GF_ADMIN_USER}:${GF_ADMIN_PASSWORD}" \
      -d "{\"name\":\"${TOKEN_NAME}\"}" \
      "${GRAFANA_URL}/api/serviceaccounts/${SA_ID}/tokens")

    # Extract the generated token
    GENERATED_TOKEN=$(echo "${TOKEN_RESPONSE}" | grep -o '"key":"[^"]*"' | sed 's/"key":"//;s/"//')

    if [ -n "${GENERATED_TOKEN}" ]; then
      echo "✅ Service account token created successfully!"
      echo ""
      echo "=================================================="
      echo "⚠️  IMPORTANT: SAVE THIS TOKEN NOW!"
      echo "=================================================="
      echo "Grafana generates the token value - it cannot be retrieved later."
      echo ""
      echo "Token: ${GENERATED_TOKEN}"
      echo ""
      echo "=================================================="
      echo "MCP Grafana Configuration"
      echo "=================================================="
      echo "Add to ~/.cursor/mcp.json:"
      echo ""
      cat << EOF
{
  "mcpServers": {
    "grafana": {
      "command": "docker",
      "args": ["run", "--rm", "-i", "-e", "GRAFANA_URL", "-e", "GRAFANA_SERVICE_ACCOUNT_TOKEN", "mcp/grafana", "-t", "stdio"],
      "env": {
        "GRAFANA_URL": "https://grafana.silverseekers.org",
        "GRAFANA_SERVICE_ACCOUNT_TOKEN": "${GENERATED_TOKEN}"
      }
    }
  }
}
EOF
      echo "=================================================="
    else
      echo "❌ Failed to create token"
      echo "Response: ${TOKEN_RESPONSE}"
      exit 1
    fi

---
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-mcp-setup
  namespace: monitoring
  annotations:
    # Run after Grafana is deployed
    argocd.argoproj.io/sync-wave: "10"
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: curlimages/curl:8.5.0
          command: ["/bin/sh", "/scripts/setup.sh"]
          env:
            - name: GRAFANA_URL
              value: "http://grafana.monitoring.svc:80"
            - name: GF_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: grafana-admin-secret
                  key: admin-user
            - name: GF_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-admin-secret
                  key: admin-password
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: grafana-mcp-setup-script
            defaultMode: 0755


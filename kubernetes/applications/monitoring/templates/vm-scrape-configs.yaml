---
# VMServiceScrape for Kubelet metrics
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMNodeScrape
metadata:
  name: kubelet
  namespace: monitoring
spec:
  scheme: https
  tlsConfig:
    insecureSkipVerify: true
    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
  interval: "60s"
  scrapeTimeout: "30s"
  relabelConfigs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)

---
# VMServiceScrape for Kubelet cadvisor (container metrics)
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMNodeScrape
metadata:
  name: kubelet-cadvisor
  namespace: monitoring
spec:
  scheme: https
  path: /metrics/cadvisor
  tlsConfig:
    insecureSkipVerify: true
    caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
  interval: "60s"
  scrapeTimeout: "30s"
  relabelConfigs:
    - action: labelmap
      regex: __meta_kubernetes_node_label_(.+)

---
# VMServiceScrape for CoreDNS
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMServiceScrape
metadata:
  name: coredns
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - kube-system
  selector:
    matchLabels:
      k8s-app: kube-dns
  endpoints:
    - port: metrics
      interval: "60s"

---
# VMServiceScrape for kube-apiserver
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMServiceScrape
metadata:
  name: kube-apiserver
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - default
  selector:
    matchLabels:
      component: apiserver
      provider: kubernetes
  endpoints:
    - port: https
      scheme: https
      tlsConfig:
        insecureSkipVerify: true
        caFile: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
      interval: "60s"

---
# VMPodScrape for pods with prometheus.io annotations
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMPodScrape
metadata:
  name: pods-with-annotations
  namespace: monitoring
spec:
  namespaceSelector:
    any: true
  selector: {}
  podMetricsEndpoints:
    - relabelConfigs:
        # Only scrape pods with prometheus.io/scrape=true
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: "true"
        # Construct address from pod IP and custom port annotation
        - sourceLabels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          targetLabel: __address__
          regex: (.+);(.+)
          replacement: ${1}:${2}
        # Use custom path if specified
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          action: replace
          targetLabel: __metrics_path__
          regex: (.+)
        # Add pod labels
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        # Add namespace label
        - sourceLabels: [__meta_kubernetes_namespace]
          action: replace
          targetLabel: namespace
        # Add pod name label
        - sourceLabels: [__meta_kubernetes_pod_name]
          action: replace
          targetLabel: pod

---
# =============================================================================
# Traefik Metrics Scrape
# =============================================================================
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMPodScrape
metadata:
  name: traefik
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - traefik
  selector:
    matchLabels:
      app.kubernetes.io/name: traefik
  podMetricsEndpoints:
    - port: metrics
      interval: "30s"
      path: /metrics

---
# =============================================================================
# ArgoCD Metrics Scrapes
# =============================================================================
# ArgoCD Application Controller
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMPodScrape
metadata:
  name: argocd-application-controller
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - argocd
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-application-controller
  podMetricsEndpoints:
    - port: metrics
      interval: "30s"
      path: /metrics

---
# ArgoCD Server
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMPodScrape
metadata:
  name: argocd-server
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - argocd
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-server
  podMetricsEndpoints:
    - port: metrics
      interval: "30s"
      path: /metrics

---
# ArgoCD Repo Server
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMPodScrape
metadata:
  name: argocd-repo-server
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - argocd
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-repo-server
  podMetricsEndpoints:
    - port: metrics
      interval: "30s"
      path: /metrics

---
# =============================================================================
# Longhorn Metrics Scrape
# =============================================================================
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMServiceScrape
metadata:
  name: longhorn
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - longhorn-system
  selector:
    matchLabels:
      app: longhorn-manager
  endpoints:
    - port: manager
      interval: "30s"
      path: /metrics

---
# =============================================================================
# Cert-Manager Metrics Scrape
# =============================================================================
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMServiceScrape
metadata:
  name: cert-manager
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
      - cert-manager
  selector:
    matchLabels:
      app.kubernetes.io/component: controller
      app.kubernetes.io/instance: cert-manager
  endpoints:
    - port: tcp-prometheus-servicemonitor
      interval: "60s"
      path: /metrics


---
# Standalone Grafana Helm Values
# Configured to use Victoria Metrics as datasource

# Single replica for homelab
replicas: 1

# Admin credentials from existing secret
admin:
  existingSecret: grafana-admin-secret
  userKey: admin-user
  passwordKey: admin-password

# Persistence for dashboards (local-path for single-node cluster)
persistence:
  enabled: true
  storageClassName: local-path
  size: 5Gi

# Service configuration
service:
  type: ClusterIP
  port: 80

# Disable ingress (using Traefik IngressRoute)
ingress:
  enabled: false

# Resources (no sidecars = much lower memory)
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 300m
    memory: 256Mi

# Disable sidecars (major memory savings)
sidecar:
  dashboards:
    enabled: false
  datasources:
    enabled: false

# Grafana configuration
grafana.ini:
  server:
    serve_from_sub_path: false
    root_url: "{{ 'https://' + grafana_domain if grafana_domain is defined else 'http://localhost:3000' }}"
  auth.anonymous:
    enabled: false
  # Feature toggles
  feature_toggles:
    enable: "publicDashboards"
  # =========================================================================
  # Authentik SSO Integration (OIDC)
  # =========================================================================
  # Prerequisites:
  #   1. Deploy Authentik (make authentik-install)
  #   2. Create OAuth2/OIDC provider in Authentik Admin UI
  #   3. Create application linked to the provider
  #   4. Add OIDC client secret to secrets.yml and seal it
  #
  # To enable: uncomment the section below and add the client secret
  # -------------------------------------------------------------------------
  # auth.generic_oauth:
  #   enabled: true
  #   name: Authentik
  #   allow_sign_up: true
  #   client_id: grafana
  #   # client_secret is loaded from environment variable
  #   scopes: openid profile email
  #   auth_url: https://{{ authentik_domain | default('auth.silverseekers.org') }}/application/o/authorize/
  #   token_url: https://{{ authentik_domain | default('auth.silverseekers.org') }}/application/o/token/
  #   api_url: https://{{ authentik_domain | default('auth.silverseekers.org') }}/application/o/userinfo/
  #   # Map Authentik groups to Grafana roles
  #   role_attribute_path: contains(groups[*], 'Grafana Admins') && 'Admin' || contains(groups[*], 'Grafana Editors') && 'Editor' || 'Viewer'
  #   # Allow users to be auto-provisioned
  #   auto_login: false
  # -------------------------------------------------------------------------

# Environment from secret
envFromSecret: grafana-admin-secret

# Additional environment variables for OIDC (uncomment when enabling SSO)
# env:
#   GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
#     valueFrom:
#       secretKeyRef:
#         name: grafana-oidc-secret
#         key: client-secret

# Datasources - Victoria Metrics (Prometheus compatible)
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: VictoriaMetrics
        type: prometheus
        url: http://vmsingle-vmsingle.monitoring.svc:8429
        access: proxy
        isDefault: true
        editable: true
        jsonData:
          timeInterval: "60s"
          httpMethod: "POST"
      # Alertmanager datasource for alert status
      - name: Alertmanager
        type: alertmanager
        url: http://vmalertmanager-vmalertmanager.monitoring.svc:9093
        access: proxy
        jsonData:
          implementation: prometheus

# Dashboard providers
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: "default"
        orgId: 1
        folder: ""
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Pre-load dashboards from Grafana.com
# These replicate the dashboards from kube-prometheus-stack
dashboards:
  default:
    # === Victoria Metrics ===
    victoriametrics:
      gnetId: 10229
      revision: 35
      datasource: VictoriaMetrics

    # === Kubernetes Cluster Overview ===
    kubernetes-cluster:
      gnetId: 7249
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes cluster monitoring (Prometheus)
    k8s-cluster-prometheus:
      gnetId: 315
      revision: 3
      datasource: VictoriaMetrics

    # === Kubernetes Compute Resources ===
    # Compute Resources / Cluster
    k8s-resources-cluster:
      gnetId: 7187
      revision: 1
      datasource: VictoriaMetrics

    # Compute Resources / Namespace (Pods)
    k8s-resources-namespace:
      gnetId: 10000
      revision: 1
      datasource: VictoriaMetrics

    # Compute Resources / Pod
    k8s-resources-pod:
      gnetId: 6781
      revision: 1
      datasource: VictoriaMetrics

    # === Kubernetes System ===
    # Kubernetes API Server
    k8s-apiserver:
      gnetId: 12654
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes Kubelet
    k8s-kubelet:
      gnetId: 16361
      revision: 1
      datasource: VictoriaMetrics

    # CoreDNS
    coredns:
      gnetId: 14981
      revision: 2
      datasource: VictoriaMetrics

    # === Node Metrics ===
    # Node Exporter Full
    node-exporter:
      gnetId: 1860
      revision: 31
      datasource: VictoriaMetrics

    # Node Exporter for Prometheus
    node-exporter-prometheus:
      gnetId: 11074
      revision: 9
      datasource: VictoriaMetrics

    # === Storage ===
    # Persistent Volumes
    persistent-volumes:
      gnetId: 13646
      revision: 2
      datasource: VictoriaMetrics

    # === Workloads ===
    # Kubernetes Pods
    kubernetes-pods:
      gnetId: 6336
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes Deployments
    k8s-deployments:
      gnetId: 8588
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes StatefulSets
    k8s-statefulsets:
      gnetId: 8588
      revision: 1
      datasource: VictoriaMetrics

    # === Networking ===
    # Kubernetes Networking
    k8s-networking:
      gnetId: 12124
      revision: 1
      datasource: VictoriaMetrics

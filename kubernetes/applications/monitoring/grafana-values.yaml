---
# Standalone Grafana Helm Values
# Configured to use Victoria Metrics as datasource

# Single replica for homelab
replicas: 1

# Admin credentials from existing secret
admin:
  existingSecret: grafana-admin-secret
  userKey: admin-user
  passwordKey: admin-password

# Persistence for dashboards (local-path for single-node cluster)
persistence:
  enabled: true
  storageClassName: local-path
  size: 5Gi

# Service configuration
service:
  type: ClusterIP
  port: 80

# Disable ingress (using Traefik IngressRoute)
ingress:
  enabled: false

# Resources (with sidecars enabled)
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Enable sidecars for auto-loading dashboards/datasources from ConfigMaps
sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
    labelValue: "1"
    folder: /tmp/dashboards
    searchNamespace: ALL
  datasources:
    enabled: true
    label: grafana_datasource
    labelValue: "1"
    searchNamespace: ALL

# Grafana configuration
grafana.ini:
  server:
    serve_from_sub_path: false
    root_url: "https://grafana.silverseekers.org"
  auth.anonymous:
    enabled: false
  # Feature toggles
  feature_toggles:
    enable: "publicDashboards"
  # =========================================================================
  # Authelia SSO Integration (OIDC)
  # =========================================================================
  # Client secret is loaded from grafana-oidc-secret.
  auth.generic_oauth:
    enabled: true
    name: Authelia
    allow_sign_up: true
    client_id: grafana
    # client_secret is loaded from environment variable GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET
    scopes: openid profile email groups
    # Authelia OIDC endpoints
    auth_url: https://auth.silverseekers.org/api/oidc/authorization
    token_url: https://auth.silverseekers.org/api/oidc/token
    api_url: https://auth.silverseekers.org/api/oidc/userinfo
    # TLS verification is controlled via environment variable from grafana-tls-config ConfigMap
    # This is dynamically set based on global.cert_issuer in homelab.yaml
    # - letsencrypt-staging: tls_skip_verify_insecure = true
    # - letsencrypt-prod: tls_skip_verify_insecure = false
    # Token endpoint auth method - must match Authelia's client config (client_secret_post)
    # Options: AutoDetect, inParams (client_secret_post), inHeader (client_secret_basic)
    auth_style: inParams
    # Email and name extraction from userinfo response
    email_attribute_path: email
    name_attribute_path: name
    # Use email as login to avoid conflicts with built-in 'admin' user
    login_attribute_path: email
    # Map Authelia groups to Grafana roles
    # Includes 'admins' group for convenience (maps to GrafanaAdmin)
    role_attribute_path: contains(groups[*], 'admins') && 'GrafanaAdmin' || contains(groups[*], 'grafana_admins') && 'Admin' || contains(groups[*], 'grafana_editors') && 'Editor' || 'Viewer'
    # Allow OAuth users to be assigned Grafana admin role
    allow_assign_grafana_admin: true
    # Auto-login disabled - users can choose local or SSO
    auto_login: false
    # Use PKCE for enhanced security
    use_pkce: true
  # Allow linking OAuth identity to existing users by email
  auth:
    oauth_allow_insecure_email_lookup: true

# Environment from secret
envFromSecret: grafana-admin-secret

# Environment from ConfigMaps (TLS config based on cert_issuer)
envFromConfigMaps:
  - name: grafana-tls-config

# Environment variables from secrets (OIDC client secret)
envValueFrom:
  GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
    secretKeyRef:
      name: grafana-oidc-secret
      key: client-secret

# Datasources - Victoria Metrics (Prometheus compatible)
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      - name: VictoriaMetrics
        type: prometheus
        url: http://vmsingle-vmsingle.monitoring.svc:8429
        access: proxy
        isDefault: true
        editable: true
        jsonData:
          timeInterval: "60s"
          httpMethod: "POST"
      # Alertmanager datasource for alert status
      - name: Alertmanager
        type: alertmanager
        url: http://vmalertmanager-vmalertmanager.monitoring.svc:9093
        access: proxy
        jsonData:
          implementation: prometheus

# Dashboard providers
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: "default"
        orgId: 1
        folder: ""
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards/default

# Pre-load dashboards from Grafana.com
# These replicate the dashboards from kube-prometheus-stack
dashboards:
  default:
    # === Victoria Metrics ===
    victoriametrics:
      gnetId: 10229
      revision: 35
      datasource: VictoriaMetrics

    # === Kubernetes Cluster Overview ===
    kubernetes-cluster:
      gnetId: 7249
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes cluster monitoring (Prometheus)
    k8s-cluster-prometheus:
      gnetId: 315
      revision: 3
      datasource: VictoriaMetrics

    # === Kubernetes Compute Resources ===
    # Compute Resources / Cluster
    k8s-resources-cluster:
      gnetId: 7187
      revision: 1
      datasource: VictoriaMetrics

    # Compute Resources / Namespace (Pods)
    k8s-resources-namespace:
      gnetId: 10000
      revision: 1
      datasource: VictoriaMetrics

    # Compute Resources / Pod
    k8s-resources-pod:
      gnetId: 6781
      revision: 1
      datasource: VictoriaMetrics

    # === Kubernetes System ===
    # Kubernetes API Server
    k8s-apiserver:
      gnetId: 12654
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes Kubelet
    k8s-kubelet:
      gnetId: 16361
      revision: 1
      datasource: VictoriaMetrics

    # CoreDNS
    coredns:
      gnetId: 14981
      revision: 2
      datasource: VictoriaMetrics

    # === Node Metrics ===
    # Node Exporter Full
    node-exporter:
      gnetId: 1860
      revision: 31
      datasource: VictoriaMetrics

    # Node Exporter for Prometheus
    node-exporter-prometheus:
      gnetId: 11074
      revision: 9
      datasource: VictoriaMetrics

    # === Storage ===
    # Persistent Volumes
    persistent-volumes:
      gnetId: 13646
      revision: 2
      datasource: VictoriaMetrics

    # === Workloads ===
    # Kubernetes Pods
    kubernetes-pods:
      gnetId: 6336
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes Deployments
    k8s-deployments:
      gnetId: 8588
      revision: 1
      datasource: VictoriaMetrics

    # Kubernetes StatefulSets
    k8s-statefulsets:
      gnetId: 8588
      revision: 1
      datasource: VictoriaMetrics

    # === Networking ===
    # Kubernetes Networking
    k8s-networking:
      gnetId: 12124
      revision: 1
      datasource: VictoriaMetrics

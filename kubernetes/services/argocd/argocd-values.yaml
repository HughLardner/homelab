---
# ArgoCD Helm Values Configuration
# Install with: helm upgrade --install argocd argo/argo-cd --namespace argocd --values values.yaml

# Global settings
global:
  # Domain for the ArgoCD server
  domain: "{{ argocd_domain }}"

# Server configuration
server:
  # Replicas for high availability
  replicas: {{ argocd_replicas | default(1) }}

  # Service configuration
  service:
    type: LoadBalancer
    servicePortHttp: 80
    servicePortHttps: 443
    annotations:
      # Homepage auto-discovery
      gethomepage.dev/enabled: "true"
      gethomepage.dev/group: "Infrastructure"
      gethomepage.dev/name: "ArgoCD"
      gethomepage.dev/icon: "argocd"
      gethomepage.dev/description: "GitOps Continuous Delivery"
      gethomepage.dev/href: "https://{{ argocd_domain }}"

  # Resource limits
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# Controller configuration
controller:
  replicas: {{ argocd_controller_replicas | default(1) }}

  resources:
    requests:
      cpu: "250m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

# Repo server configuration
repoServer:
  replicas: {{ argocd_repo_replicas | default(1) }}

  resources:
    requests:
      cpu: "100m"
      memory: "128Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

# ApplicationSet controller
applicationSet:
  replicas: {{ argocd_appset_replicas | default(1) }}

  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Redis configuration (used for caching)
redis:
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "256Mi"

# Dex configuration (OIDC provider - disabled, using local auth)
dex:
  enabled: false

# Notifications controller (optional)
notifications:
  enabled: {{ argocd_notifications_enabled | default('false') }}

# Configs
configs:
  # Params configuration (argocd-cmd-params-cm)
  params:
    # Run in insecure mode - TLS termination at Traefik ingress
    server.insecure: true
    # Skip TLS verification for OIDC (for Let's Encrypt staging certs)
    oidc.tls.insecure.skip.verify: true

  # Secret configuration
  secret:
    # Create the argocd-secret (password will be set by Ansible)
    createSecret: true

  # ConfigMap configuration
  cm:
    # Admin account enabled
    admin.enabled: "true"

    # URL for the ArgoCD server (used in notifications and webhooks)
    url: "https://{{ argocd_domain }}"

    # Disable anonymous access
    users.anonymous.enabled: "false"

    # Enable status badge
    statusbadge.enabled: "true"

    # Resource tracking method
    application.resourceTrackingMethod: annotation

    # =========================================================================
    # Authelia SSO Integration (OIDC)
    # =========================================================================
    # Client secret is stored in argocd-oidc-secret.
    # rootCA is conditionally included for Let's Encrypt staging certificates
    oidc.config: |
      name: Authelia
      issuer: https://{{ services.authelia.domain | default('auth.' + global.domain) }}
      clientID: argocd
      clientSecret: $oidc.authelia.clientSecret
      requestedScopes:
        - openid
        - profile
        - email
        - groups
{% if global.cert_issuer == 'letsencrypt-staging' %}
      rootCA: |
        -----BEGIN CERTIFICATE-----
        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
        1ihc7aoA6ccL6q+Rag==
        -----END CERTIFICATE-----
{% endif %}

  # RBAC configuration
  rbac:
    # Policy for admin role
    policy.default: role:readonly
    policy.csv: |
      g, admin, role:admin
      # Authelia Group Mappings
      g, argocd_admins, role:admin
      g, admins, role:admin

  # Repository credentials (add your repos here)
  repositories:
    homelab-repo:
      name: homelab
      url: "{{ argocd_github_repo_url }}"
      type: git
      password: "{{ argocd_github_token }}"
      username: git

  # Credential templates for GitHub (matches any github.com repo)
  credentialTemplates:
    github-https:
      url: https://github.com
      password: "{{ argocd_github_token }}"
      username: git

# Metrics for Prometheus
metrics:
  enabled: true
  serviceMonitor:
    enabled: false # Enable if using Prometheus Operator

---
# External-DNS Helm Values - CoreDNS Provider
# Watches Kubernetes resources and updates local CoreDNS via etcd
#
# This is a SECOND instance of external-dns that manages LOCAL DNS:
# - Instance 1 (existing): external-dns → Cloudflare (remote access)
# - Instance 2 (this one): external-dns → CoreDNS/etcd (local access)
#
# Deployment Methods:
# 1. Automated (Ansible): make coredns-local-install
# 2. Manual (Helm): helm upgrade --install external-dns-local external-dns/external-dns --values values.yaml
# 3. GitOps (ArgoCD): Applied via Application manifest

# Image configuration
image:
  repository: registry.k8s.io/external-dns/external-dns
  tag: v0.15.0

# High Availability configuration
replicas: 2

# Sources to watch for DNS records
# Only watching services (not traefik-proxy) to avoid API version incompatibility
# IngressRoutes expose LoadBalancer services anyway, so we'll pick them up
sources:
  - service          # Watch Services with type: LoadBalancer

# DNS provider: CoreDNS (via etcd)
provider: coredns

# CoreDNS/etcd configuration
env:
  - name: ETCD_URLS
    value: "http://coredns-etcd-client.coredns-local.svc.cluster.local:2379"

# Extra arguments for CoreDNS provider
extraArgs:
  - --coredns-prefix=/skydns  # etcd path prefix for SkyDNS format

# Domain filtering (same as Cloudflare instance)
domainFilters:
  - silverseekers.org

# TXT record ownership tracking (different from Cloudflare instance)
txtOwnerId: "k3s-cluster-local"
txtPrefix: "_external-dns-local."

# Policy: sync (full management) since this is local-only
# No risk of deleting external DNS records
policy: sync

# Synchronization interval
interval: 1m

# Logging configuration
logLevel: info
logFormat: json

# Resource limits
resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 65534
  fsGroup: 65534
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true

# Pod Disruption Budget (HA)
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Anti-affinity to spread replicas across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: external-dns
          topologyKey: kubernetes.io/hostname

# Prometheus metrics (for monitoring stack)
serviceMonitor:
  enabled: true
  namespace: monitoring
  labels:
    release: kube-prometheus-stack

# Dry-run mode (set to true for testing)
dryRun: false

# Registry type (how to track ownership)
registry: txt

---
# Post-install Job to initialize Garage
# Creates the velero bucket and access key
apiVersion: batch/v1
kind: Job
metadata:
  name: garage-init
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: garage
    app.kubernetes.io/component: init
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: garage
        app.kubernetes.io/component: init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: curlimages/curl:8.5.0
          command:
            - /bin/sh
            - -c
            - |
              set -e
              
              ADMIN_URL="http://garage-admin:3903"
              ADMIN_TOKEN=$(cat /secrets/admin-token)
              
              echo "Waiting for Garage to be ready..."
              until curl -sf "$ADMIN_URL/health"; do
                echo "Waiting for Garage admin API..."
                sleep 5
              done
              
              echo "Checking cluster status..."
              curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/status" || true
              
              # Get node ID and configure layout
              echo "Getting node ID..."
              NODE_ID=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/status" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
              
              if [ -n "$NODE_ID" ]; then
                echo "Node ID: $NODE_ID"
                
                # Check if layout already applied
                LAYOUT=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/layout" || echo "{}")
                
                if echo "$LAYOUT" | grep -q '"stagedRoleChanges":\[\]'; then
                  echo "Layout already configured"
                else
                  echo "Configuring node layout..."
                  curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"${NODE_ID}\": {\"zone\": \"dc1\", \"capacity\": 53687091200, \"tags\": [\"homelab\"]}}" \
                    "$ADMIN_URL/v1/layout" || echo "Layout staging may have failed"
                  
                  echo "Applying layout..."
                  # Get current version and increment
                  CURRENT_VERSION=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/layout" | grep -o '"version":[0-9]*' | cut -d: -f2 || echo "0")
                  NEW_VERSION=$((CURRENT_VERSION + 1))
                  
                  curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"version\": $NEW_VERSION}" \
                    "$ADMIN_URL/v1/layout/apply" || echo "Layout apply may have failed"
                fi
              fi
              
              # Create bucket if it doesn't exist
              echo "Checking for velero bucket..."
              BUCKET_EXISTS=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/bucket?globalAlias=velero" || echo "")
              
              if [ -z "$BUCKET_EXISTS" ] || echo "$BUCKET_EXISTS" | grep -q "NoSuchBucket"; then
                echo "Creating velero bucket..."
                curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"globalAlias": "velero"}' \
                  "$ADMIN_URL/v1/bucket" || echo "Bucket creation may have failed"
              else
                echo "Velero bucket already exists"
              fi
              
              # Create access key if it doesn't exist
              echo "Checking for velero access key..."
              KEY_EXISTS=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/key?search=velero" | grep -o '"id":"[^"]*"' | head -1 || echo "")
              
              if [ -z "$KEY_EXISTS" ]; then
                echo "Creating velero access key..."
                KEY_RESPONSE=$(curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"name": "velero"}' \
                  "$ADMIN_URL/v1/key")
                
                ACCESS_KEY=$(echo "$KEY_RESPONSE" | grep -o '"accessKeyId":"[^"]*"' | cut -d'"' -f4)
                SECRET_KEY=$(echo "$KEY_RESPONSE" | grep -o '"secretAccessKey":"[^"]*"' | cut -d'"' -f4)
                
                echo "Access Key created. Store these securely:"
                echo "ACCESS_KEY_ID: $ACCESS_KEY"
                echo "SECRET_ACCESS_KEY: [hidden - check logs]"
                
                # Grant bucket access to key
                KEY_ID=$(echo "$KEY_RESPONSE" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
                BUCKET_ID=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/bucket?globalAlias=velero" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
                
                if [ -n "$KEY_ID" ] && [ -n "$BUCKET_ID" ]; then
                  echo "Granting velero key access to bucket..."
                  curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"bucketId\": \"$BUCKET_ID\", \"accessKeyId\": \"$KEY_ID\", \"permissions\": {\"read\": true, \"write\": true, \"owner\": true}}" \
                    "$ADMIN_URL/v1/bucket/allow" || echo "Bucket permission may have failed"
                fi
              else
                echo "Velero access key already exists"
              fi
              
              echo "Garage initialization complete!"
          volumeMounts:
            - name: secrets
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: secrets
          secret:
            secretName: garage-credentials


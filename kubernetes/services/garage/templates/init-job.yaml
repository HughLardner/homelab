---
# Post-install Job to initialize Garage
# Creates the velero bucket and access key
apiVersion: batch/v1
kind: Job
metadata:
  name: garage-init
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: garage
    app.kubernetes.io/component: init
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: garage
        app.kubernetes.io/component: init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: curlimages/curl:8.5.0
          command:
            - /bin/sh
            - -c
            - |
              # Idempotent init script - safe to run multiple times
              
              ADMIN_URL="http://garage-admin:3903"
              ADMIN_TOKEN=$(cat /secrets/admin-token)
              
              echo "Waiting for Garage to be ready..."
              for i in 1 2 3 4 5 6; do
                if curl -sf "$ADMIN_URL/health" > /dev/null 2>&1; then
                  echo "Garage is ready"
                  break
                fi
                echo "Waiting for Garage admin API... (attempt $i)"
                sleep 5
              done
              
              # Check layout version - if > 0, layout is already configured
              LAYOUT_VERSION=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/layout" 2>/dev/null | grep -o '"version":[0-9]*' | cut -d: -f2 || echo "0")
              echo "Current layout version: $LAYOUT_VERSION"
              
              if [ "$LAYOUT_VERSION" = "0" ] || [ -z "$LAYOUT_VERSION" ]; then
                echo "Layout needs configuration..."
                NODE_ID=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/status" 2>/dev/null | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
                
                if [ -n "$NODE_ID" ]; then
                  echo "Configuring node $NODE_ID..."
                  curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "[{\"id\": \"$NODE_ID\", \"zone\": \"dc1\", \"capacity\": 53687091200, \"tags\": [\"homelab\"]}]" \
                    "$ADMIN_URL/v1/layout" 2>/dev/null || true
                  
                  curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d '{"version": 1}' \
                    "$ADMIN_URL/v1/layout/apply" 2>/dev/null || true
                  echo "Layout configured"
                fi
              else
                echo "Layout already configured (version $LAYOUT_VERSION)"
              fi
              
              # Check if bucket exists
              BUCKET_RESPONSE=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/bucket?globalAlias=velero" 2>/dev/null || echo "")
              
              if echo "$BUCKET_RESPONSE" | grep -q '"id":'; then
                echo "Velero bucket already exists"
              else
                echo "Creating velero bucket..."
                curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"globalAlias": "velero"}' \
                  "$ADMIN_URL/v1/bucket" 2>/dev/null || echo "Bucket may already exist"
              fi
              
              # Check if key exists (search returns array, check for accessKeyId)
              KEY_RESPONSE=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/key?search=velero" 2>/dev/null || echo "[]")
              
              if echo "$KEY_RESPONSE" | grep -q '"accessKeyId":'; then
                echo "Velero access key already exists"
              else
                echo "Creating velero access key..."
                NEW_KEY=$(curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                  -H "Content-Type: application/json" \
                  -d '{"name": "velero"}' \
                  "$ADMIN_URL/v1/key" 2>/dev/null || echo "")
                
                if [ -n "$NEW_KEY" ]; then
                  ACCESS_KEY=$(echo "$NEW_KEY" | grep -o '"accessKeyId":"[^"]*"' | cut -d'"' -f4)
                  echo "Created access key: $ACCESS_KEY"
                  echo "IMPORTANT: Check logs for secret key on first run"
                  
                  # Grant bucket access
                  KEY_ID=$(echo "$NEW_KEY" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
                  BUCKET_ID=$(curl -sf -H "Authorization: Bearer $ADMIN_TOKEN" "$ADMIN_URL/v1/bucket?globalAlias=velero" 2>/dev/null | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
                  
                  if [ -n "$KEY_ID" ] && [ -n "$BUCKET_ID" ]; then
                    curl -sf -X POST -H "Authorization: Bearer $ADMIN_TOKEN" \
                      -H "Content-Type: application/json" \
                      -d "{\"bucketId\": \"$BUCKET_ID\", \"accessKeyId\": \"$KEY_ID\", \"permissions\": {\"read\": true, \"write\": true, \"owner\": true}}" \
                      "$ADMIN_URL/v1/bucket/allow" 2>/dev/null || true
                  fi
                fi
              fi
              
              echo "Garage initialization complete!"
              exit 0
          volumeMounts:
            - name: secrets
              mountPath: /secrets
              readOnly: true
      volumes:
        - name: secrets
          secret:
            secretName: garage-credentials


---
# Post-install Job to initialize Garage
# Configures layout, creates velero bucket and access key
# Uses the garage binary via kubectl exec for reliability
apiVersion: batch/v1
kind: Job
metadata:
  name: garage-init
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: garage
    app.kubernetes.io/component: init
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 6
  template:
    metadata:
      labels:
        app.kubernetes.io/name: garage
        app.kubernetes.io/component: init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: garage-init
      containers:
        - name: init
          image: bitnami/kubectl:1.28
          command:
            - /bin/sh
            - -c
            - |
              # Idempotent init script using garage CLI
              # Waits for pod, then configures via kubectl exec
              
              echo "Waiting for garage-0 pod to be ready..."
              for i in $(seq 1 30); do
                if kubectl -n {{ .Release.Namespace }} get pod garage-0 -o jsonpath='{.status.phase}' 2>/dev/null | grep -q Running; then
                  echo "garage-0 is running"
                  break
                fi
                echo "Waiting for garage-0... (attempt $i)"
                sleep 5
              done
              
              # Wait additional time for garage to fully start
              sleep 10
              
              echo "=== Checking layout status ==="
              STATUS=$(kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage status 2>&1 || echo "FAILED")
              echo "$STATUS"
              
              # Check if layout needs configuration (NO ROLE ASSIGNED indicates unconfigured)
              if echo "$STATUS" | grep -q "NO ROLE ASSIGNED"; then
                echo "=== Configuring layout ==="
                NODE_ID=$(echo "$STATUS" | grep -E "^[a-f0-9]{16}" | awk '{print $1}')
                
                if [ -n "$NODE_ID" ]; then
                  echo "Assigning role to node $NODE_ID..."
                  kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage layout assign "$NODE_ID" -z dc1 -c 50G -t homelab
                  
                  echo "Applying layout..."
                  kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage layout apply --version 1
                  
                  echo "Layout configured successfully"
                else
                  echo "ERROR: Could not determine node ID"
                  exit 1
                fi
              else
                echo "Layout already configured"
              fi
              
              echo "=== Checking buckets ==="
              BUCKETS=$(kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage bucket list 2>&1)
              echo "$BUCKETS"
              
              if echo "$BUCKETS" | grep -q "velero"; then
                echo "Velero bucket already exists"
              else
                echo "Creating velero bucket..."
                kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage bucket create velero
              fi
              
              echo "=== Checking keys ==="
              KEYS=$(kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage key list 2>&1)
              echo "$KEYS"
              
              # Read predefined credentials from secret
              ACCESS_KEY_ID=$(cat /secrets/velero-access-key-id)
              SECRET_ACCESS_KEY=$(cat /secrets/velero-secret-access-key)
              
              if echo "$KEYS" | grep -q "velero"; then
                echo "Velero key already exists"
              else
                echo "Importing velero access key with predefined credentials..."
                # Import ensures same key ID works across cluster rebuilds
                kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage key import \
                  --yes -n velero "$ACCESS_KEY_ID" "$SECRET_ACCESS_KEY"
                
                echo "Granting velero key access to bucket..."
                kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage bucket allow --read --write --owner velero --key velero
              fi
              
              echo "=== Final status ==="
              kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage status
              kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage bucket list
              kubectl -n {{ .Release.Namespace }} exec garage-0 -- /garage key list
              
              echo "Garage initialization complete!"
          volumeMounts:
            - name: garage-secrets
              mountPath: /secrets
              readOnly: true
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
      volumes:
        - name: garage-secrets
          secret:
            secretName: garage-credentials


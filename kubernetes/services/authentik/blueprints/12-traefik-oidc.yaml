# Authentik Blueprint: Traefik Dashboard OIDC Provider
# Configures OAuth2/OIDC for Traefik dashboard access
#
# After deployment, Traefik dashboard will be protected by SSO.
# Only users in "Traefik Admins" group can access the dashboard.

version: 1
metadata:
  name: Traefik Dashboard OIDC Provider
  labels:
    blueprints.goauthentik.io/description: "Traefik dashboard SSO integration"
context:
  traefik_client_id: traefik
  traefik_redirect_uri: https://traefik.silverseekers.org/_oauth
entries:
  # ============================================
  # OAuth2 Provider
  # ============================================
  - model: authentik_providers_oauth2.oauth2provider
    id: provider-traefik
    attrs:
      name: Traefik Dashboard
      authorization_flow:
        !Find [
          authentik_flows.flow,
          [slug, default-provider-authorization-implicit-consent],
        ]
      client_type: confidential
      client_id: !Context traefik_client_id
      client_secret: !Env [OIDC_TRAEFIK_SECRET, "changeme"]
      redirect_uris: !Context traefik_redirect_uri
      signing_key:
        !Find [
          authentik_crypto.certificatekeypair,
          [name, "authentik Self-signed Certificate"],
        ]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]

  # ============================================
  # Application
  # ============================================
  - model: authentik_core.application
    id: app-traefik
    attrs:
      name: Traefik Dashboard
      slug: traefik
      provider: !KeyOf provider-traefik
      meta_icon: https://traefik.io/static/traefik-proxy-logo--light-mode.svg
      meta_description: "Ingress controller dashboard"
      meta_publisher: "Traefik Labs"
      meta_launch_url: https://traefik.silverseekers.org
      policy_engine_mode: any

# Authentik Blueprint: Forward Authentication Provider
# Configures a proxy provider for protecting any service via Traefik ForwardAuth
#
# This is used to protect services that don't natively support OIDC.
# Add the authentik ForwardAuth middleware to any IngressRoute to protect it.
#
# Usage in IngressRoute:
#   middlewares:
#     - name: authentik-forward-auth
#       namespace: traefik

version: 1
metadata:
  name: Forward Authentication Provider
  labels:
    blueprints.goauthentik.io/description: "Generic ForwardAuth for Traefik"
entries:
  # ============================================
  # Proxy Provider for ForwardAuth
  # ============================================
  - model: authentik_providers_proxy.proxyprovider
    id: provider-forward-auth
    attrs:
      name: "Traefik ForwardAuth"
      authorization_flow:
        !Find [
          authentik_flows.flow,
          [slug, default-provider-authorization-implicit-consent],
        ]
      mode: forward_single
      # External host is the Authentik server URL
      external_host: https://auth.silverseekers.org
      # Access token validity
      access_token_validity: hours=24

  # ============================================
  # Application for ForwardAuth
  # ============================================
  - model: authentik_core.application
    id: app-forward-auth
    attrs:
      name: "Protected Services"
      slug: protected-services
      provider: !KeyOf provider-forward-auth
      meta_icon: https://goauthentik.io/img/icon.png
      meta_description: "Services protected by ForwardAuth"
      meta_publisher: "Homelab"
      policy_engine_mode: any

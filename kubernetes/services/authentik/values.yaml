---
# Authentik Helm Values Configuration
# Install with: helm upgrade --install authentik authentik/authentik --namespace authentik --values values.yaml

# Global authentik configuration
global:
  # Environment variables from existing Kubernetes secret
  env:
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: secret-key
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: postgresql-password
    # Bootstrap credentials for automated initial setup
    - name: AUTHENTIK_BOOTSTRAP_PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: bootstrap-password
    - name: AUTHENTIK_BOOTSTRAP_TOKEN
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: bootstrap-token
    - name: AUTHENTIK_BOOTSTRAP_EMAIL
      value: "admin@silverseekers.org"
    # OIDC client secrets for declarative blueprint configuration
    - name: OIDC_GRAFANA_SECRET
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: oidc-grafana-secret
    - name: OIDC_ARGOCD_SECRET
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: oidc-argocd-secret
    - name: OIDC_TRAEFIK_SECRET
      valueFrom:
        secretKeyRef:
          name: authentik-secrets
          key: oidc-traefik-secret

# Authentik-specific configuration
authentik:
  # Disable error reporting for privacy
  error_reporting:
    enabled: false

# Server (Web UI and API) configuration
server:
  replicas: 1

  # Disable built-in ingress (using Traefik IngressRoute instead)
  ingress:
    enabled: false

  # Resource limits (optimized for homelab)
  resources:
    requests:
      cpu: "100m"
      memory: "512Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

  # Metrics for Prometheus
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false # Enable if using Prometheus Operator

  # Mount blueprints ConfigMap for declarative configuration
  volumes:
    - name: blueprints
      configMap:
        name: authentik-blueprints
  volumeMounts:
    - name: blueprints
      mountPath: /blueprints/custom

# Worker (background tasks) configuration
worker:
  replicas: 1

  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "500m"
      memory: "512Mi"

  # Mount blueprints ConfigMap for declarative configuration
  volumes:
    - name: blueprints
      configMap:
        name: authentik-blueprints
  volumeMounts:
    - name: blueprints
      mountPath: /blueprints/custom

# PostgreSQL configuration (bundled)
postgresql:
  enabled: true
  # Use latest tag (Bitnami deprecated versioned images in Aug 2025)
  image:
    registry: docker.io
    repository: bitnami/postgresql
    tag: "latest"
  auth:
    existingSecret: authentik-secrets
    secretKeys:
      adminPasswordKey: postgresql-password
      userPasswordKey: postgresql-password
  primary:
    persistence:
      enabled: true
      storageClass: "{{ authentik_storage_class | default('longhorn') }}"
      size: "{{ authentik_postgresql_storage_size | default('8Gi') }}"
    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "512Mi"

# Redis configuration (bundled)
redis:
  enabled: true
  # Use latest tag (Bitnami deprecated versioned images in Aug 2025)
  image:
    registry: docker.io
    repository: bitnami/redis
    tag: "latest"
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      storageClass: "{{ authentik_storage_class | default('longhorn') }}"
      size: "{{ authentik_redis_storage_size | default('1Gi') }}"
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "200m"
        memory: "128Mi"

# Service account
serviceAccount:
  create: true

# Pod security context
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

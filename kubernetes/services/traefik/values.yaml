---
# Traefik Helm Values Configuration
# Install with: helm upgrade --install traefik traefik/traefik --namespace traefik --values values.yaml

# Global settings
globalArguments:
  - "--global.checknewversion=false"
  - "--global.sendanonymoususage=false"

# Additional arguments
additionalArguments:
  - "--log.level=INFO"
  - "--accesslog=true"
  - "--accesslog.bufferingsize=100"
  - "--api.dashboard=true"
  - "--api.insecure=false"  # Dashboard requires authentication
  - "--ping=true"
  - "--providers.kubernetesingress.ingressclass=traefik"
  - "--providers.kubernetescrd.allowCrossNamespace=true"
  - "--entrypoints.websecure.http.tls=true"
  - "--entrypoints.websecure.http.tls.certResolver=letsencrypt"

# Deployment configuration
deployment:
  enabled: true
  kind: Deployment
  replicas: 1  # Reduced from 2 - HA not needed for homelab infrastructure

# Service configuration
service:
  enabled: true
  type: {{ traefik_service_type | default('LoadBalancer') }}
  annotations:
    metallb.universe.tf/allow-shared-ip: "traefik-lb"
    metallb.universe.tf/loadBalancerIPs: "192.168.10.145"  # Lock static IP
    external-dns.alpha.kubernetes.io/hostname: "traefik.{{ traefik_domain | default('silverseekers.org') }}"
    external-dns.alpha.kubernetes.io/ttl: "300"
  spec:
    # MetalLB will assign an IP from the pool
    loadBalancerIP: {{ traefik_loadbalancer_ip | default('') }}

# Ports configuration
ports:
  web:
    port: 80
    expose:
      default: true
    exposedPort: 80
    protocol: TCP
    # Redirect HTTP to HTTPS
    redirectTo:
      port: websecure
  websecure:
    port: 443
    expose:
      default: true
    exposedPort: 443
    protocol: TCP
    tls:
      enabled: true
      # Cert-manager will handle certificates
  traefik:
    port: 9000
    expose:
      default: false  # Dashboard accessed via IngressRoute
    exposedPort: 9000
    protocol: TCP
  metrics:
    port: 9100
    expose:
      default: false
    exposedPort: 9100
    protocol: TCP

# IngressClass
ingressClass:
  enabled: true
  isDefaultClass: true
  name: traefik

# IngressRoute configuration
ingressRoute:
  dashboard:
    enabled: false  # We'll create custom IngressRoute with TLS

# Providers
providers:
  kubernetesCRD:
    enabled: true
    allowCrossNamespace: true
    allowExternalNameServices: true
  kubernetesIngress:
    enabled: true
    allowExternalNameServices: true
    publishedService:
      enabled: true

# Resources
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "500m"
    memory: "512Mi"

# Security context
securityContext:
  capabilities:
    drop: [ALL]
    add: [NET_BIND_SERVICE]
  readOnlyRootFilesystem: true
  runAsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532

# Pod security context
podSecurityContext:
  fsGroup: 65532
  runAsNonRoot: true
  runAsUser: 65532
  runAsGroup: 65532

# Persistence for certificates
# Disabled since cert-manager handles all TLS certificates
# Enable only if using Traefik's built-in ACME
persistence:
  enabled: false

# Prometheus metrics
metrics:
  prometheus:
    enabled: true
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
    entryPoint: metrics

# Logging
logs:
  general:
    level: INFO
  access:
    enabled: true
    bufferingSize: 100

# Health checks
livenessProbe:
  httpGet:
    path: /ping
    port: 9000
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ping
    port: 9000
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 1

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Affinity rules (spread across nodes)
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: traefik
          topologyKey: kubernetes.io/hostname

---
# External-DNS Helm Values Configuration
# Automated DNS record management for Kubernetes resources
#
# Deployment Methods:
# 1. Automated (Ansible): make external-dns-install
# 2. Manual (Helm): helm upgrade --install external-dns external-dns/external-dns --values values.yaml
# 3. GitOps (ArgoCD): Applied via Application manifest

# Image configuration
image:
  repository: registry.k8s.io/external-dns/external-dns
  tag: v0.19.0  # v0.20.0 has EndpointSlice sync bug causing crashloop

# High Availability configuration
replicas: {{ external_dns_replicas | default(2) }}

# Sources to watch for DNS records
# Note: traefik-proxy disabled until Traefik CRDs are installed
sources:
  - service          # Watch Services with type: LoadBalancer

# DNS provider
provider: cloudflare

# Cloudflare configuration
env:
  - name: CF_API_TOKEN
    valueFrom:
      secretKeyRef:
        name: cloudflare-api-token
        key: cloudflare_api_token

# Domain filtering (security)
domainFilters:
  - {{ external_dns_domain | default('silverseekers.org') }}

# TXT record ownership tracking
txtOwnerId: "{{ cluster_name | default('k3s-cluster') }}"
txtPrefix: "_external-dns."

# Policy: upsert-only (safe) or sync (full management including deletion)
policy: {{ external_dns_policy | default('upsert-only') }}

# Synchronization interval
interval: 1m

# Logging configuration
logLevel: {{ external_dns_log_level | default('info') }}
logFormat: json

# Resource limits
resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 65534
  fsGroup: 65534
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true

# Pod Disruption Budget (HA)
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Anti-affinity to spread replicas across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: external-dns
          topologyKey: kubernetes.io/hostname

# Prometheus metrics (for monitoring stack)
# Disabled until Prometheus Operator is installed
serviceMonitor:
  enabled: false
  namespace: monitoring
  labels:
    release: kube-prometheus-stack

# Dry-run mode (set to true for testing)
dryRun: false

# Registry type
registry: txt

# Additional arguments
extraArgs:
  - --txt-wildcard-replacement=wildcard

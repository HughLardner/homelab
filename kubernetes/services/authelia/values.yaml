---
# Authelia Helm Values Configuration
# Lightweight SSO with OIDC support for homelab
# Chart version: 0.9.x

# Domain for Authelia
domain: silverseekers.org

# Single replica for homelab
pod:
  kind: Deployment
  replicas: 1
  
  # Resource limits
  resources:
    requests:
      cpu: "10m"
      memory: "64Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"
  
  # Mount users database
  extraVolumes:
    - name: users-database
      secret:
        secretName: authelia-users
  extraVolumeMounts:
    - name: users-database
      mountPath: /config/users_database.yml
      subPath: users_database.yml
      readOnly: true

# Ingress disabled (using Traefik IngressRoute)
ingress:
  enabled: false

# Persistence for SQLite database
persistence:
  enabled: true
  storageClass: "longhorn"
  size: 1Gi

# Authelia configuration
configMap:
  # Theme
  theme: dark
  
  # Logging
  log:
    level: info
    format: text
  
  # Disable telemetry
  telemetry:
    metrics:
      enabled: false
  
  # TOTP (2FA) configuration
  totp:
    disable: false
    issuer: silverseekers.org
  
  # WebAuthn (passkeys)
  webauthn:
    disable: true
  
  # Authentication backend (file-based) - MUST HAVE enabled: true
  authentication_backend:
    password_reset:
      disable: true
    file:
      enabled: true
      path: /config/users_database.yml
      password:
        algorithm: argon2
  
  # Session configuration
  session:
    cookies:
      - domain: silverseekers.org
        authelia_url: https://auth.silverseekers.org
    redis:
      enabled: true
      enabledSecret: false
      host: authelia-redis-master
      port: 6379
      password:
        disabled: true
  
  # Storage backend (SQLite) - MUST HAVE enabled: true
  # Note: PV is mounted at /config, so use that path
  storage:
    local:
      enabled: true
      path: /config/db.sqlite3
  
  # Notifier (filesystem for homelab) - MUST HAVE enabled: true
  notifier:
    disable_startup_check: true
    filesystem:
      enabled: true
      filename: /config/notifications.txt
  
  # Access control rules
  access_control:
    default_policy: one_factor
    rules:
      # Allow API endpoints for OIDC
      - domain: auth.silverseekers.org
        policy: bypass
        resources:
          - "^/api/.*$"
          - "^/.well-known/.*$"
  
  # Identity Providers (OIDC) - DISABLED for now
  # OIDC requires JWKS key pair which adds complexity
  # Using ForwardAuth for all services instead
  # TODO: Enable OIDC after configuring JWKS properly
  identity_providers:
    oidc:
      enabled: false

# Redis subchart
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      storageClass: "longhorn"
      size: 1Gi
    resources:
      requests:
        cpu: "10m"
        memory: "16Mi"
      limits:
        cpu: "100m"
        memory: "64Mi"

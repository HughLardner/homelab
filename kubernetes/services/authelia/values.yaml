---
# Authelia Helm Values Configuration
# Lightweight SSO with OIDC support for homelab
# Memory footprint: ~30-50MB vs Authentik's ~900MB

# Image configuration
image:
  registry: ghcr.io
  repository: authelia/authelia
  tag: "4.38"
  pullPolicy: IfNotPresent

# Single replica for homelab
replicaCount: 1

# Resource limits (very lightweight)
resources:
  requests:
    cpu: "10m"
    memory: "32Mi"
  limits:
    cpu: "200m"
    memory: "128Mi"

# Ingress disabled (using Traefik IngressRoute)
ingress:
  enabled: false

# Service configuration
service:
  type: ClusterIP
  port: 9091

# Pod configuration
pod:
  kind: Deployment
  replicas: 1
  env:
    # Secrets loaded from environment
    - name: AUTHELIA_JWT_SECRET_FILE
      value: /secrets/jwt-secret
    - name: AUTHELIA_SESSION_SECRET_FILE
      value: /secrets/session-secret
    - name: AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE
      value: /secrets/storage-encryption-key
    - name: AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET_FILE
      value: /secrets/oidc-hmac-secret
  extraVolumes:
    - name: authelia-secrets
      secret:
        secretName: authelia-secrets
    - name: users-database
      configMap:
        name: authelia-users
  extraVolumeMounts:
    - name: authelia-secrets
      mountPath: /secrets
      readOnly: true
    - name: users-database
      mountPath: /config/users.yml
      subPath: users.yml
      readOnly: true

# Authelia configuration
configMap:
  enabled: true
  
  # Theme
  theme: dark
  
  # Default redirection URL
  default_redirection_url: https://auth.silverseekers.org
  
  # Server configuration  
  server:
    host: 0.0.0.0
    port: 9091
    path: ""
    asset_path: ""
    headers:
      csp_template: ""
    buffers:
      read: 4096
      write: 4096
    timeouts:
      read: 6s
      write: 6s
      idle: 30s
  
  # Logging
  log:
    level: info
    format: text
  
  # TOTP (2FA) configuration
  totp:
    disable: false
    issuer: silverseekers.org
    algorithm: sha1
    digits: 6
    period: 30
    skew: 1
  
  # WebAuthn (passkeys)
  webauthn:
    disable: true
  
  # Authentication backend (file-based for simplicity)
  authentication_backend:
    password_reset:
      disable: true
    file:
      path: /config/users.yml
      watch: true
      password:
        algorithm: argon2
        argon2:
          variant: argon2id
          iterations: 3
          memory: 65536
          parallelism: 4
          key_length: 32
          salt_length: 16
  
  # Session configuration
  session:
    name: authelia_session
    domain: silverseekers.org
    same_site: lax
    expiration: 1h
    inactivity: 5m
    remember_me_duration: 1M
    # Redis for session storage
    redis:
      host: authelia-redis-master.authelia.svc.cluster.local
      port: 6379
      database_index: 0
  
  # Storage backend (SQLite for lightweight deployment)
  storage:
    local:
      path: /data/db.sqlite3
  
  # Notifier (filesystem for homelab - no email)
  notifier:
    disable_startup_check: true
    filesystem:
      filename: /data/notifications.txt
  
  # Access control rules
  access_control:
    default_policy: deny
    rules:
      # Allow API endpoints for OIDC
      - domain: auth.silverseekers.org
        policy: bypass
        resources:
          - "^/api/.*$"
          - "^/.well-known/.*$"
      
      # Grafana - requires authentication
      - domain: grafana.silverseekers.org
        policy: one_factor
        subject:
          - "group:admins"
          - "group:grafana_admins"
          - "group:grafana_editors"
          - "group:grafana_viewers"
      
      # ArgoCD - requires authentication
      - domain: argocd.silverseekers.org
        policy: one_factor
        subject:
          - "group:admins"
          - "group:argocd_admins"
      
      # Traefik Dashboard - admin only
      - domain: traefik.silverseekers.org
        policy: one_factor
        subject:
          - "group:admins"
      
      # Longhorn UI - admin only
      - domain: longhorn.silverseekers.org
        policy: one_factor
        subject:
          - "group:admins"
      
      # Default: all authenticated users for other services
      - domain: "*.silverseekers.org"
        policy: one_factor
  
  # Identity Providers (OIDC)
  identity_providers:
    oidc:
      # Clients configured via YAML
      clients:
        # Grafana OIDC Client
        - client_id: grafana
          client_name: Grafana
          client_secret: '$pbkdf2-sha512$310000$PLACEHOLDER_GRAFANA_HASH'
          public: false
          authorization_policy: one_factor
          consent_mode: implicit
          redirect_uris:
            - https://grafana.silverseekers.org/login/generic_oauth
          scopes:
            - openid
            - profile
            - email
            - groups
          userinfo_signed_response_alg: none
          token_endpoint_auth_method: client_secret_post
        
        # ArgoCD OIDC Client
        - client_id: argocd
          client_name: ArgoCD
          client_secret: '$pbkdf2-sha512$310000$PLACEHOLDER_ARGOCD_HASH'
          public: false
          authorization_policy: one_factor
          consent_mode: implicit
          redirect_uris:
            - https://argocd.silverseekers.org/auth/callback
          scopes:
            - openid
            - profile
            - email
            - groups
          userinfo_signed_response_alg: none
          token_endpoint_auth_method: client_secret_basic

# Persistence for SQLite database
persistence:
  enabled: true
  storageClass: "longhorn"
  size: 1Gi
  accessMode: ReadWriteOnce

# Redis subchart (bundled, lightweight)
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false
  master:
    persistence:
      enabled: true
      storageClass: "longhorn"
      size: 1Gi
    resources:
      requests:
        cpu: "10m"
        memory: "16Mi"
      limits:
        cpu: "100m"
        memory: "64Mi"

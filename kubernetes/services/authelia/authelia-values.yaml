---
# Authelia Helm Values Configuration
# Lightweight SSO with OIDC support for homelab
# Chart version: 0.9.x

# Domain for Authelia
domain: silverseekers.org

# Single replica for homelab
pod:
  kind: Deployment
  replicas: 1
  
  # Resource limits
  resources:
    requests:
      cpu: "10m"
      memory: "64Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"
  
  # Mount users database
  extraVolumes:
    - name: users-database
      secret:
        secretName: authelia-users
  extraVolumeMounts:
    - name: users-database
      mountPath: /config/users_database.yml
      subPath: users_database.yml
      readOnly: true

# Service configuration
service:
  annotations:
    # Homepage auto-discovery
    gethomepage.dev/enabled: "true"
    gethomepage.dev/group: "Infrastructure"
    gethomepage.dev/name: "Authelia"
    gethomepage.dev/icon: "authelia"
    gethomepage.dev/description: "Single Sign-On Authentication"
    gethomepage.dev/href: "https://auth.silverseekers.org"

# Ingress disabled (using Traefik IngressRoute)
ingress:
  enabled: false

# Persistence for SQLite database
persistence:
  enabled: true
  storageClass: "longhorn"
  size: 1Gi

# Secret configuration - use our existing sealed secret
secret:
  existingSecret: 'authelia-secrets'
  
  # Map our secret keys to what Authelia expects
  jwt:
    key: 'jwt-secret'
  session:
    key: 'session-secret'
  storageEncryptionKey:
    key: 'storage-encryption-key'
  
  # Mount additional secrets for OIDC
  additionalSecrets:
    authelia-secrets:
      items:
        - key: 'oidc.jwks.RS256.pem'
          path: 'oidc.jwks.RS256.pem'
        - key: 'oidc-hmac-secret'
          path: 'oidc-hmac-secret'

# Authelia configuration
configMap:
  # Theme
  theme: dark
  
  # Logging
  log:
    level: info
    format: text
  
  # Disable telemetry
  telemetry:
    metrics:
      enabled: false
  
  # TOTP (2FA) configuration
  totp:
    disable: false
    issuer: silverseekers.org
  
  # WebAuthn (passkeys)
  webauthn:
    disable: true
  
  # Authentication backend (file-based)
  authentication_backend:
    password_reset:
      disable: true
    file:
      enabled: true
      path: /config/users_database.yml
      password:
        algorithm: argon2
  
  # Session configuration (in-memory for single replica - no Redis needed)
  session:
    cookies:
      - subdomain: auth
        domain: silverseekers.org
        authelia_url: https://auth.silverseekers.org
        default_redirection_url: https://home.silverseekers.org
  
  # Storage backend (SQLite)
  storage:
    local:
      enabled: true
      path: /config/db.sqlite3
  
  # Notifier (filesystem for homelab)
  notifier:
    disable_startup_check: true
    filesystem:
      enabled: true
      filename: /config/notifications.txt
  
  # Access control rules
  access_control:
    default_policy: one_factor
    rules:
      # Allow OIDC/API endpoints without auth
      - domain: auth.silverseekers.org
        policy: bypass
        resources:
          - "^/api/.*$"
          - "^/.well-known/.*$"
      # All other subdomains require one-factor auth
      - domain: "*.silverseekers.org"
        policy: one_factor
  
  # Identity Providers (OIDC)
  identity_providers:
    oidc:
      enabled: true
      
      # HMAC secret for OIDC (from existing secret)
      hmac_secret:
        secret_name: 'authelia-secrets'
        path: 'oidc-hmac-secret'
      
      # JWKS configuration
      jwks:
        - key_id: 'authelia-rs256'
          algorithm: 'RS256'
          use: 'sig'
          key:
            path: '/secrets/authelia-secrets/oidc.jwks.RS256.pem'
      
      # OIDC Clients
      clients:
        # Grafana OIDC Client
        # Secret must match grafana-oidc-secret in config/secrets.yml
        - client_id: grafana
          client_name: Grafana
          client_secret: '$plaintext$7cc7e1a8589e7316cc3f3b24d17f64a5789fc05650d5b6d81c04931b34f19c6d'
          public: false
          authorization_policy: one_factor
          consent_mode: implicit
          redirect_uris:
            - https://grafana.silverseekers.org/login/generic_oauth
          scopes:
            - openid
            - profile
            - email
            - groups
          token_endpoint_auth_method: client_secret_post
        
        # ArgoCD OIDC Client
        # Secret must match argocd-oidc-secret in config/secrets.yml
        - client_id: argocd
          client_name: ArgoCD
          client_secret: '$plaintext$c13af2e6c3eeb5c6a8e765f954f754d32690235e23ce061957b9074d4a03e394'
          public: false
          authorization_policy: one_factor
          consent_mode: implicit
          redirect_uris:
            - https://argocd.silverseekers.org/auth/callback
          scopes:
            - openid
            - profile
            - email
            - groups
          # ArgoCD actually uses client_secret_basic (not post)
          token_endpoint_auth_method: client_secret_basic
        
        # Home Assistant OIDC Client
        # Requires hass-oidc-auth HACS integration
        # Secret must match home-assistant-oidc-secret in config/secrets.yml
        - client_id: home-assistant
          client_name: Home Assistant
          client_secret: '$plaintext$4972a5e37c87f2d0d1f530f028a279ecc829c61647cc5b889c9fbe2374e80694'
          public: false
          authorization_policy: one_factor
          consent_mode: implicit
          redirect_uris:
            - https://home-assistant.silverseekers.org/auth/oidc/callback
          scopes:
            - openid
            - profile
            - email
            - groups
          token_endpoint_auth_method: client_secret_post

# Redis subchart - disabled for single-replica homelab (in-memory sessions work fine)
redis:
  enabled: false


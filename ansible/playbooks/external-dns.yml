---
# External-DNS Installation Playbook
# Installs external-dns for automated DNS record management
#
# Prerequisites:
#   - K3s cluster running
#   - Traefik LoadBalancer deployed
#   - Cloudflare API token with DNS:Edit permission
#
# Usage:
#   ansible-playbook playbooks/external-dns.yml
#
# Variables (from Terraform via inventory):
#   - cloudflare_api_token: Cloudflare API token (required)
#   - external_dns_domain: Domain to manage (default: silverseekers.org)
#   - external_dns_replicas: Number of replicas (default: 2)
#   - external_dns_policy: upsert-only or sync (default: upsert-only)

- name: Install External-DNS
  hosts: k3s_masters[0]
  become: true
  gather_facts: true

  vars:
    external_dns_namespace: external-dns
    external_dns_helm_repo: https://kubernetes-sigs.github.io/external-dns
    external_dns_helm_chart: external-dns
    external_dns_helm_version: "1.15.0"
    external_dns_manifests_path: "{{ playbook_dir }}/../../kubernetes/services/external-dns"

  tasks:
    # =========================================================================
    # Pre-flight Checks
    # =========================================================================
    - name: Verify required variables
      ansible.builtin.assert:
        that:
          - cloudflare_api_token is defined and cloudflare_api_token | length > 0
          - external_dns_domain is defined and external_dns_domain | length > 0
        fail_msg: "Required variables cloudflare_api_token and external_dns_domain must be set"
        success_msg: "All required variables are set"

    - name: Check if Traefik is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get namespace traefik
      register: traefik_ns_check
      changed_when: false
      failed_when: false

    - name: Warn if Traefik not installed
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è  WARNING: Traefik namespace not found. External-DNS requires Traefik for IngressRoute support."
      when: traefik_ns_check.rc != 0

    # =========================================================================
    # Namespace Setup
    # =========================================================================
    - name: Create external-dns namespace
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl create namespace {{ external_dns_namespace }} --dry-run=client -o yaml
      register: namespace_yaml
      changed_when: false

    - name: Apply external-dns namespace
      ansible.builtin.shell: |
        echo '{{ namespace_yaml.stdout }}' | /usr/local/bin/k3s kubectl apply -f -
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"
      register: namespace_result

    # =========================================================================
    # Cloudflare Secret Setup
    # =========================================================================
    - name: Create Cloudflare API token secret
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl create secret generic cloudflare-api-token \
          --namespace={{ external_dns_namespace }} \
          --from-literal=cloudflare_api_token='{{ cloudflare_api_token }}' \
          --dry-run=client -o yaml | /usr/local/bin/k3s kubectl apply -f -
      no_log: true
      register: secret_result
      changed_when: "'created' in secret_result.stdout or 'configured' in secret_result.stdout"

    # =========================================================================
    # Helm Repository Setup
    # =========================================================================
    - name: Add external-dns Helm repository
      kubernetes.core.helm_repository:
        name: external-dns
        repo_url: "{{ external_dns_helm_repo }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: false

    # =========================================================================
    # Template Helm Values
    # =========================================================================
    - name: Create temporary directory for templated values
      ansible.builtin.tempfile:
        state: directory
        prefix: external_dns_
      register: temp_dir

    - name: Template external-dns Helm values
      ansible.builtin.template:
        src: "{{ external_dns_manifests_path }}/values.yaml"
        dest: "{{ temp_dir.path }}/values.yaml"
        mode: "0644"

    # =========================================================================
    # Install External-DNS via Helm
    # =========================================================================
    - name: Install or upgrade external-dns via Helm
      kubernetes.core.helm:
        name: external-dns
        chart_ref: external-dns/{{ external_dns_helm_chart }}
        chart_version: "{{ external_dns_helm_version }}"
        release_namespace: "{{ external_dns_namespace }}"
        create_namespace: true
        wait: true
        wait_timeout: 300s
        values_files:
          - "{{ temp_dir.path }}/values.yaml"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # =========================================================================
    # Wait for External-DNS Deployment
    # =========================================================================
    - name: Wait for external-dns deployment
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/k3s kubectl rollout status deployment/external-dns
          -n {{ external_dns_namespace }} --timeout=300s
      changed_when: false

    # =========================================================================
    # Cleanup and Verification
    # =========================================================================
    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent
      when: temp_dir.path is defined

    - name: Get external-dns pods status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get pods -n {{ external_dns_namespace }} -o wide
      register: external_dns_pods
      changed_when: false

    - name: Get external-dns deployment
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get deployment -n {{ external_dns_namespace }}
      register: external_dns_deployment
      changed_when: false

    - name: Get recent logs
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl logs -n {{ external_dns_namespace }} -l app.kubernetes.io/name=external-dns --tail=20
      register: external_dns_logs
      changed_when: false
      failed_when: false

    # =========================================================================
    # Display Completion Message
    # =========================================================================
    - name: Build completion message
      ansible.builtin.set_fact:
        completion_message: |
          ========================================
          ‚úÖ External-DNS Installation Complete!
          ========================================

          üìä Deployment Status:
          {{ external_dns_deployment.stdout }}

          üì¶ Pods Status:
          {{ external_dns_pods.stdout }}

          üìã Recent Logs:
          {{ external_dns_logs.stdout | default('Logs not available yet') }}

          ========================================
          üìù Next Steps:
          ========================================
          1. Verify DNS operations:
             kubectl logs -n {{ external_dns_namespace }} -l app.kubernetes.io/name=external-dns -f

          2. Annotate your resources:
             # For LoadBalancer Services:
             annotations:
               external-dns.alpha.kubernetes.io/hostname: "service.{{ external_dns_domain }}"

             # For Traefik IngressRoutes:
             annotations:
               external-dns.alpha.kubernetes.io/target: "traefik.{{ external_dns_domain }}"

          3. Verify DNS records in Cloudflare:
             - Check for A records (LoadBalancers)
             - Check for CNAME records (IngressRoutes)
             - Check for TXT ownership records (_external-dns.*)

          4. Test DNS resolution:
             dig traefik.{{ external_dns_domain }} +short
             dig argocd.{{ external_dns_domain }} +short

          ========================================
          üìö Documentation:
          ========================================
          See kubernetes/services/external-dns/README.md for:
          - Annotation reference
          - Troubleshooting guide
          - Policy upgrade (upsert-only ‚Üí sync)
          - Monitoring and metrics

          ========================================

    - name: Display completion message
      ansible.builtin.debug:
        msg: "{{ completion_message.split('\n') }}"

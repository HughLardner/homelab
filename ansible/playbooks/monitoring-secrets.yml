---
# Monitoring Secrets Playbook
# Creates Kubernetes secrets required for monitoring stack
#
# Prerequisites:
#   - K3s cluster running
#   - Monitoring namespace exists (created by ArgoCD)
#
# Usage:
#   ansible-playbook playbooks/monitoring-secrets.yml
#
# Variables (from Terraform via inventory):
#   - grafana_domain: Domain for Grafana UI (required)
#   - grafana_admin_password: Admin password (required)

- name: Create Monitoring Secrets
  hosts: k3s_masters[0]
  become: true
  gather_facts: false

  vars_files:
    - "{{ playbook_dir }}/../../config/homelab.yaml"

  vars:
    monitoring_namespace: monitoring
    # Variables loaded from config/homelab.yaml via vars_files
    grafana_domain: "{{ services.grafana.domain }}"

  tasks:
    # =========================================================================
    # Pre-flight Checks
    # =========================================================================
    - name: Verify required variables
      ansible.builtin.assert:
        that:
          - grafana_domain is defined and grafana_domain | length > 0
          - grafana_admin_password is defined and grafana_admin_password | length > 0
        fail_msg: "Required variables grafana_domain and grafana_admin_password must be set"
        success_msg: "All required variables are set"

    # =========================================================================
    # Create Namespace
    # =========================================================================
    - name: Create monitoring namespace
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl create namespace {{ monitoring_namespace }} --dry-run=client -o yaml
      register: namespace_yaml
      changed_when: false

    - name: Apply monitoring namespace
      ansible.builtin.shell: |
        echo '{{ namespace_yaml.stdout }}' | /usr/local/bin/k3s kubectl apply -f -
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"
      register: namespace_result

    # =========================================================================
    # Create Grafana Admin Secret
    # =========================================================================
    - name: Create Grafana admin secret
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: grafana-admin-secret
            namespace: "{{ monitoring_namespace }}"
          type: Opaque
          stringData:
            admin-user: "admin"
            admin-password: "{{ grafana_admin_password }}"
            GF_SERVER_ROOT_URL: "https://{{ grafana_domain }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # =========================================================================
    # Apply Grafana OIDC Sealed Secret
    # =========================================================================
    - name: Check if Grafana OIDC sealed secret exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../../kubernetes/applications/monitoring/secrets/grafana-oidc-sealed.yaml"
      register: grafana_oidc_sealed
      delegate_to: localhost
      become: false

    - name: Copy Grafana OIDC sealed secret to node
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../kubernetes/applications/monitoring/secrets/grafana-oidc-sealed.yaml"
        dest: /tmp/grafana-oidc-sealed.yaml
        mode: '0600'
      when: grafana_oidc_sealed.stat.exists

    - name: Apply Grafana OIDC sealed secret
      kubernetes.core.k8s:
        state: present
        src: /tmp/grafana-oidc-sealed.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when: grafana_oidc_sealed.stat.exists

    - name: Clean up OIDC sealed secret temp file
      ansible.builtin.file:
        path: /tmp/grafana-oidc-sealed.yaml
        state: absent
      when: grafana_oidc_sealed.stat.exists

    - name: Wait for Grafana OIDC secret to be unsealed
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: grafana-oidc-secret
        namespace: "{{ monitoring_namespace }}"
      register: grafana_oidc_secret
      until: grafana_oidc_secret.resources | length > 0
      retries: 30
      delay: 2
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when: grafana_oidc_sealed.stat.exists

    # =========================================================================
    # Verification
    # =========================================================================
    - name: Verify secret was created
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get secret grafana-admin-secret -n {{ monitoring_namespace }}
      register: secret_status
      changed_when: false

    - name: Display success message
      ansible.builtin.debug:
        msg:
          - "âœ… Monitoring secrets created successfully!"
          - ""
          - "Secret: grafana-admin-secret"
          - "Namespace: {{ monitoring_namespace }}"
          - "Keys: admin-user, admin-password, GF_SERVER_ROOT_URL"
          - ""
          - "Next steps:"
          - "  1. Deploy monitoring via ArgoCD: make root-app-deploy"
          - "  2. Or deploy monitoring directly: make monitoring-deploy"
          - "  3. Check status: make apps-status"

---
# Authentik API Configuration Playbook
# Configures Authentik declaratively via API - NO manual UI steps required
#
# This playbook runs after authentik.yml and uses the bootstrap token
# to create all providers, applications, groups, and outpost configuration.
#
# Prerequisites:
#   - Authentik installed and running (run authentik.yml first)
#   - Bootstrap token set in authentik-secrets
#
# Usage:
#   ansible-playbook playbooks/authentik-configure.yml

- name: Configure Authentik via API
  hosts: localhost
  connection: local
  gather_facts: false
  become: false

  pre_tasks:
    - name: Load inventory for variables
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../inventory/hosts.yml"
      
    - name: Set domain variables from inventory
      ansible.builtin.set_fact:
        authentik_domain: "{{ all.children.k3s_cluster.vars.authentik_domain | default('auth.silverseekers.org') }}"
        base_domain: "{{ all.children.k3s_cluster.vars.external_dns_domain | default('silverseekers.org') }}"

    - name: Set derived URLs
      ansible.builtin.set_fact:
        authentik_url: "https://{{ authentik_domain }}"
        authentik_api: "https://{{ authentik_domain }}/api/v3"
        grafana_redirect_uri: "https://grafana.{{ base_domain }}/login/generic_oauth"
        argocd_redirect_uri: "https://argocd.{{ base_domain }}/auth/callback"
        traefik_redirect_uri: "https://traefik.{{ base_domain }}/_oauth"

  vars:
    # OIDC Client IDs
    grafana_client_id: "grafana"
    argocd_client_id: "argocd"
    traefik_client_id: "traefik"

  tasks:
    # =========================================================================
    # Load Secrets
    # =========================================================================
    - name: Load secrets from secrets.yml
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/../../secrets.yml"
      no_log: true

    - name: Extract bootstrap token
      ansible.builtin.set_fact:
        bootstrap_token: "{{ (secrets | selectattr('name', 'eq', 'authentik-secrets') | first).data['bootstrap-token'] }}"
        grafana_client_secret: "{{ (secrets | selectattr('name', 'eq', 'grafana-oidc-secret') | first).data['client-secret'] }}"
        argocd_client_secret: "{{ (secrets | selectattr('name', 'eq', 'argocd-oidc-secret') | first).data['oidc.authentik.clientSecret'] }}"
        traefik_client_secret: "{{ (secrets | selectattr('name', 'eq', 'traefik-oidc-secret') | first).data['oidc.authentik.clientSecret'] }}"
      no_log: true

    - name: Set API headers
      ansible.builtin.set_fact:
        api_headers:
          Authorization: "Bearer {{ bootstrap_token }}"
          Content-Type: "application/json"
          Accept: "application/json"
      no_log: true

    # =========================================================================
    # Wait for Authentik API
    # =========================================================================
    - name: Wait for Authentik API to be ready
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/users/me/"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
        status_code: 200
      register: api_check
      retries: 30
      delay: 10
      until: api_check.status == 200

    - name: Display API connection status
      ansible.builtin.debug:
        msg: "âœ… Connected to Authentik API as: {{ api_check.json.user.username }}"

    # =========================================================================
    # Get Required References
    # =========================================================================
    - name: Get authorization flow
      ansible.builtin.uri:
        url: "{{ authentik_api }}/flows/instances/?slug=default-provider-authorization-implicit-consent"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: auth_flow_response

    - name: Set authorization flow UUID
      ansible.builtin.set_fact:
        authorization_flow_uuid: "{{ auth_flow_response.json.results[0].pk }}"
      when: auth_flow_response.json.results | length > 0

    - name: Get invalidation flow
      ansible.builtin.uri:
        url: "{{ authentik_api }}/flows/instances/?slug=default-provider-invalidation-flow"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: invalidation_flow_response

    - name: Set invalidation flow UUID
      ansible.builtin.set_fact:
        invalidation_flow_uuid: "{{ invalidation_flow_response.json.results[0].pk }}"
      when: invalidation_flow_response.json.results | length > 0

    - name: Get signing certificate
      ansible.builtin.uri:
        url: "{{ authentik_api }}/crypto/certificatekeypairs/?name=authentik%20Self-signed%20Certificate"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: cert_response

    - name: Set signing key UUID
      ansible.builtin.set_fact:
        signing_key_uuid: "{{ cert_response.json.results[0].pk }}"
      when: cert_response.json.results | length > 0

    - name: Get all property mappings
      ansible.builtin.uri:
        url: "{{ authentik_api }}/propertymappings/all/"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: scope_mappings_response

    - name: Set scope mapping UUIDs (openid, email, profile)
      ansible.builtin.set_fact:
        scope_mapping_uuids: "{{ scope_mappings_response.json.results | selectattr('scope_name', 'defined') | selectattr('scope_name', 'in', ['openid', 'email', 'profile']) | map(attribute='pk') | list }}"

    # =========================================================================
    # Create Groups
    # =========================================================================
    - name: Define groups to create
      ansible.builtin.set_fact:
        groups_to_create:
          - name: "authentik Admins"
            is_superuser: true
          - name: "Grafana Admins"
            is_superuser: false
          - name: "Grafana Editors"
            is_superuser: false
          - name: "Grafana Viewers"
            is_superuser: false
          - name: "ArgoCD Admins"
            is_superuser: false
          - name: "ArgoCD Developers"
            is_superuser: false
          - name: "Traefik Admins"
            is_superuser: false
          - name: "Homelab Users"
            is_superuser: false

    - name: Check existing groups
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/groups/"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: existing_groups

    - name: Create groups
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/groups/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "{{ item.name }}"
          is_superuser: "{{ item.is_superuser }}"
        validate_certs: true
        status_code: [200, 201]
      loop: "{{ groups_to_create }}"
      when: item.name not in (existing_groups.json.results | map(attribute='name') | list)
      register: groups_created

    - name: Display groups status
      ansible.builtin.debug:
        msg: "âœ… Groups configured"

    # =========================================================================
    # Create Groups Scope Mapping (for OIDC)
    # =========================================================================
    - name: Check if groups scope mapping exists
      ansible.builtin.set_fact:
        existing_groups_scope: "{{ scope_mappings_response.json.results | selectattr('name', 'eq', 'Homelab Groups') | list }}"

    - name: Create groups scope mapping
      ansible.builtin.uri:
        url: "{{ authentik_api }}/propertymappings/provider/scope/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "Homelab Groups"
          scope_name: "groups"
          expression: |
            return {
                "groups": [group.name for group in request.user.ak_groups.all()]
            }
        validate_certs: true
        status_code: [200, 201]
      when: existing_groups_scope | length == 0
      register: groups_scope_created

    - name: Set groups scope UUID from creation response
      ansible.builtin.set_fact:
        groups_scope_uuid: "{{ groups_scope_created.json.pk }}"
      when: groups_scope_created is not skipped

    - name: Set groups scope UUID from existing
      ansible.builtin.set_fact:
        groups_scope_uuid: "{{ existing_groups_scope[0].pk }}"
      when: groups_scope_created is skipped and existing_groups_scope | length > 0

    - name: Display groups scope status
      ansible.builtin.debug:
        msg: "âœ… Groups scope mapping configured: {{ groups_scope_uuid }}"

    # =========================================================================
    # Create Grafana OAuth2 Provider
    # =========================================================================
    - name: Check if Grafana provider exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/?name=Grafana"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: grafana_provider_check

    - name: Create Grafana OAuth2 provider
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "Grafana"
          authorization_flow: "{{ authorization_flow_uuid }}"
          invalidation_flow: "{{ invalidation_flow_uuid }}"
          client_type: "confidential"
          client_id: "{{ grafana_client_id }}"
          client_secret: "{{ grafana_client_secret }}"
          redirect_uris: "{{ grafana_redirect_uri }}"
          signing_key: "{{ signing_key_uuid }}"
          property_mappings: "{{ scope_mapping_uuids + [groups_scope_uuid] }}"
        validate_certs: true
        status_code: [200, 201]
      when: grafana_provider_check.json.results | length == 0
      register: grafana_provider_created
      no_log: true

    - name: Get Grafana provider ID
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/?name=Grafana"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: grafana_provider_result

    - name: Set Grafana provider ID
      ansible.builtin.set_fact:
        grafana_provider_id: "{{ grafana_provider_result.json.results[0].pk }}"
      when: grafana_provider_result.json.results | length > 0

    # =========================================================================
    # Create Grafana Application
    # =========================================================================
    - name: Check if Grafana application exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/?slug=grafana"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: grafana_app_check

    - name: Create Grafana application
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "Grafana"
          slug: "grafana"
          provider: "{{ grafana_provider_id }}"
          meta_launch_url: "https://grafana.{{ base_domain }}"
          meta_description: "Metrics visualization and dashboards"
          meta_publisher: "Grafana Labs"
          policy_engine_mode: "any"
        validate_certs: true
        status_code: [200, 201]
      when: grafana_app_check.json.results | length == 0

    - name: Display Grafana status
      ansible.builtin.debug:
        msg: "âœ… Grafana OIDC provider and application configured"

    # =========================================================================
    # Create ArgoCD OAuth2 Provider
    # =========================================================================
    - name: Check if ArgoCD provider exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/?name=ArgoCD"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: argocd_provider_check

    - name: Create ArgoCD OAuth2 provider
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "ArgoCD"
          authorization_flow: "{{ authorization_flow_uuid }}"
          invalidation_flow: "{{ invalidation_flow_uuid }}"
          client_type: "confidential"
          client_id: "{{ argocd_client_id }}"
          client_secret: "{{ argocd_client_secret }}"
          redirect_uris: "{{ argocd_redirect_uri }}"
          signing_key: "{{ signing_key_uuid }}"
          property_mappings: "{{ scope_mapping_uuids + [groups_scope_uuid] }}"
        validate_certs: true
        status_code: [200, 201]
      when: argocd_provider_check.json.results | length == 0
      register: argocd_provider_created
      no_log: true

    - name: Get ArgoCD provider ID
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/?name=ArgoCD"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: argocd_provider_result

    - name: Set ArgoCD provider ID
      ansible.builtin.set_fact:
        argocd_provider_id: "{{ argocd_provider_result.json.results[0].pk }}"
      when: argocd_provider_result.json.results | length > 0

    # =========================================================================
    # Create ArgoCD Application
    # =========================================================================
    - name: Check if ArgoCD application exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/?slug=argocd"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: argocd_app_check

    - name: Create ArgoCD application
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "ArgoCD"
          slug: "argocd"
          provider: "{{ argocd_provider_id }}"
          meta_launch_url: "https://argocd.{{ base_domain }}"
          meta_description: "GitOps continuous delivery"
          meta_publisher: "Argo Project"
          policy_engine_mode: "any"
        validate_certs: true
        status_code: [200, 201]
      when: argocd_app_check.json.results | length == 0

    - name: Display ArgoCD status
      ansible.builtin.debug:
        msg: "âœ… ArgoCD OIDC provider and application configured"

    # =========================================================================
    # Create Traefik OAuth2 Provider
    # =========================================================================
    - name: Check if Traefik provider exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/?name=Traefik%20Dashboard"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: traefik_provider_check

    - name: Create Traefik OAuth2 provider
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "Traefik Dashboard"
          authorization_flow: "{{ authorization_flow_uuid }}"
          invalidation_flow: "{{ invalidation_flow_uuid }}"
          client_type: "confidential"
          client_id: "{{ traefik_client_id }}"
          client_secret: "{{ traefik_client_secret }}"
          redirect_uris: "{{ traefik_redirect_uri }}"
          signing_key: "{{ signing_key_uuid }}"
          property_mappings: "{{ scope_mapping_uuids }}"
        validate_certs: true
        status_code: [200, 201]
      when: traefik_provider_check.json.results | length == 0
      register: traefik_provider_created
      no_log: true

    - name: Get Traefik provider ID
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/oauth2/?name=Traefik%20Dashboard"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: traefik_provider_result

    - name: Set Traefik provider ID
      ansible.builtin.set_fact:
        traefik_provider_id: "{{ traefik_provider_result.json.results[0].pk }}"
      when: traefik_provider_result.json.results | length > 0

    # =========================================================================
    # Create Traefik Application
    # =========================================================================
    - name: Check if Traefik application exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/?slug=traefik"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: traefik_app_check

    - name: Create Traefik application
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "Traefik Dashboard"
          slug: "traefik"
          provider: "{{ traefik_provider_id }}"
          meta_launch_url: "https://traefik.{{ base_domain }}"
          meta_description: "Ingress controller dashboard"
          meta_publisher: "Traefik Labs"
          policy_engine_mode: "any"
        validate_certs: true
        status_code: [200, 201]
      when: traefik_app_check.json.results | length == 0

    - name: Display Traefik status
      ansible.builtin.debug:
        msg: "âœ… Traefik OIDC provider and application configured"

    # =========================================================================
    # Create ForwardAuth Proxy Provider
    # =========================================================================
    - name: Check if ForwardAuth provider exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/proxy/?name=Traefik%20ForwardAuth"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: forwardauth_provider_check

    - name: Create ForwardAuth proxy provider
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/proxy/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "Traefik ForwardAuth"
          authorization_flow: "{{ authorization_flow_uuid }}"
          invalidation_flow: "{{ invalidation_flow_uuid }}"
          mode: "forward_single"
          external_host: "{{ authentik_url }}"
          access_token_validity: "hours=24"
        validate_certs: true
        status_code: [200, 201]
      when: forwardauth_provider_check.json.results | length == 0
      register: forwardauth_provider_created

    - name: Get ForwardAuth provider ID
      ansible.builtin.uri:
        url: "{{ authentik_api }}/providers/proxy/?name=Traefik%20ForwardAuth"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: forwardauth_provider_result

    - name: Set ForwardAuth provider ID
      ansible.builtin.set_fact:
        forwardauth_provider_id: "{{ forwardauth_provider_result.json.results[0].pk }}"
      when: forwardauth_provider_result.json.results | length > 0

    # =========================================================================
    # Create Protected Services Application
    # =========================================================================
    - name: Check if Protected Services application exists
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/?slug=protected-services"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: protected_app_check

    - name: Create Protected Services application
      ansible.builtin.uri:
        url: "{{ authentik_api }}/core/applications/"
        method: POST
        headers: "{{ api_headers }}"
        body_format: json
        body:
          name: "Protected Services"
          slug: "protected-services"
          provider: "{{ forwardauth_provider_id }}"
          meta_description: "Services protected by ForwardAuth"
          meta_publisher: "Homelab"
          policy_engine_mode: "any"
        validate_certs: true
        status_code: [200, 201]
      when: protected_app_check.json.results | length == 0

    - name: Display ForwardAuth status
      ansible.builtin.debug:
        msg: "âœ… ForwardAuth proxy provider configured"

    # =========================================================================
    # Configure Embedded Outpost
    # =========================================================================
    - name: Get embedded outpost
      ansible.builtin.uri:
        url: "{{ authentik_api }}/outposts/instances/?name=authentik%20Embedded%20Outpost"
        method: GET
        headers: "{{ api_headers }}"
        validate_certs: true
      register: embedded_outpost_result

    - name: Update embedded outpost with ForwardAuth provider
      ansible.builtin.uri:
        url: "{{ authentik_api }}/outposts/instances/{{ embedded_outpost_result.json.results[0].pk }}/"
        method: PATCH
        headers: "{{ api_headers }}"
        body_format: json
        body:
          providers:
            - "{{ forwardauth_provider_id }}"
        validate_certs: true
        status_code: [200]
      when: embedded_outpost_result.json.results | length > 0

    - name: Display outpost status
      ansible.builtin.debug:
        msg: "âœ… Embedded outpost configured with ForwardAuth provider"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display configuration summary
      ansible.builtin.debug:
        msg:
          - "========================================"
          - "âœ… Authentik Configuration Complete!"
          - "========================================"
          - ""
          - "ðŸ“¦ Created Resources:"
          - "  â€¢ 8 User Groups"
          - "  â€¢ Grafana OIDC Provider + Application"
          - "  â€¢ ArgoCD OIDC Provider + Application"
          - "  â€¢ Traefik OIDC Provider + Application"
          - "  â€¢ ForwardAuth Proxy Provider"
          - "  â€¢ Protected Services Application"
          - "  â€¢ Embedded Outpost Configuration"
          - ""
          - "ðŸ”— OIDC Endpoints:"
          - "  Issuer: {{ authentik_url }}/application/o/grafana/"
          - "  Auth:   {{ authentik_url }}/application/o/authorize/"
          - "  Token:  {{ authentik_url }}/application/o/token/"
          - "  User:   {{ authentik_url }}/application/o/userinfo/"
          - ""
          - "ðŸ“š Next Steps:"
          - "  1. Verify applications at {{ authentik_url }}/if/admin/#/core/applications"
          - "  2. Create users and assign to groups"
          - "  3. Enable OIDC in Grafana and ArgoCD configs"
          - ""
          - "========================================"

---
# Authentik Secrets Playbook
# Applies sealed secrets required for Authentik SSO
#
# Prerequisites:
#   - K3s cluster running
#   - Sealed Secrets controller installed
#   - Sealed secrets files created (run: make seal-secrets)
#
# Usage:
#   ansible-playbook playbooks/authentik-secrets.yml
#
# Secrets Applied:
#   - authentik-secrets: Core Authentik secrets (secret-key, postgresql-password, etc.)
#   - grafana-oidc-secret: OIDC client secret for Grafana (optional)
#   - argocd-oidc-secret: OIDC client secret for ArgoCD (optional)

- name: Apply Authentik Secrets
  hosts: k3s_masters[0]
  become: true
  gather_facts: false

  vars:
    authentik_namespace: authentik
    monitoring_namespace: monitoring
    argocd_namespace: argocd
    secrets_base_path: "{{ playbook_dir }}/../../kubernetes"

  tasks:
    # =========================================================================
    # Create Namespaces
    # =========================================================================
    - name: Create Authentik namespace
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl create namespace {{ authentik_namespace }} --dry-run=client -o yaml
      register: authentik_ns_yaml
      changed_when: false

    - name: Apply Authentik namespace
      ansible.builtin.shell: |
        echo '{{ authentik_ns_yaml.stdout }}' | /usr/local/bin/k3s kubectl apply -f -
      register: authentik_ns_result
      changed_when: "'created' in authentik_ns_result.stdout or 'configured' in authentik_ns_result.stdout"

    # =========================================================================
    # Apply Authentik Core Secrets
    # =========================================================================
    - name: Check if Authentik sealed secrets file exists
      ansible.builtin.stat:
        path: "{{ secrets_base_path }}/services/authentik/secrets/authentik-secrets-sealed.yaml"
      delegate_to: localhost
      become: false
      register: authentik_sealed_file

    - name: Fail if Authentik sealed secrets not found
      ansible.builtin.fail:
        msg: |
          ❌ Authentik sealed secrets file not found!

          Please create secrets first:
          1. Add authentik-secrets to secrets.yml (see secrets.example.yml)
          2. Run: make seal-secrets
          3. Then run this playbook again

          Expected file: kubernetes/services/authentik/secrets/authentik-secrets-sealed.yaml
      when: not authentik_sealed_file.stat.exists

    - name: Read Authentik sealed secrets file
      ansible.builtin.slurp:
        src: "{{ secrets_base_path }}/services/authentik/secrets/authentik-secrets-sealed.yaml"
      delegate_to: localhost
      become: false
      register: authentik_sealed_content

    - name: Apply Authentik sealed secrets
      ansible.builtin.shell: |
        echo '{{ authentik_sealed_content.content | b64decode }}' | /usr/local/bin/k3s kubectl apply -f -
      register: authentik_secret_result
      changed_when: "'created' in authentik_secret_result.stdout or 'configured' in authentik_secret_result.stdout"

    - name: Wait for Authentik secret to be decrypted
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get secret authentik-secrets -n {{ authentik_namespace }}
      register: authentik_secret_wait
      until: authentik_secret_wait.rc == 0
      retries: 30
      delay: 2

    # =========================================================================
    # Apply Grafana OIDC Secret (Optional)
    # =========================================================================
    - name: Check if Grafana OIDC sealed secrets file exists
      ansible.builtin.stat:
        path: "{{ secrets_base_path }}/applications/monitoring/secrets/grafana-oidc-sealed.yaml"
      delegate_to: localhost
      become: false
      register: grafana_oidc_sealed_file

    - name: Read Grafana OIDC sealed secrets file
      ansible.builtin.slurp:
        src: "{{ secrets_base_path }}/applications/monitoring/secrets/grafana-oidc-sealed.yaml"
      delegate_to: localhost
      become: false
      register: grafana_oidc_content
      when: grafana_oidc_sealed_file.stat.exists

    - name: Apply Grafana OIDC sealed secrets (if exists)
      ansible.builtin.shell: |
        echo '{{ grafana_oidc_content.content | b64decode }}' | /usr/local/bin/k3s kubectl apply -f -
      register: grafana_oidc_result
      changed_when: "'created' in grafana_oidc_result.stdout or 'configured' in grafana_oidc_result.stdout"
      when: grafana_oidc_sealed_file.stat.exists

    - name: Wait for Grafana OIDC secret to be decrypted
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get secret grafana-oidc-secret -n {{ monitoring_namespace }}
      register: grafana_oidc_wait
      until: grafana_oidc_wait.rc == 0
      retries: 30
      delay: 2
      when: grafana_oidc_sealed_file.stat.exists

    # =========================================================================
    # Apply ArgoCD OIDC Secret (Optional)
    # =========================================================================
    - name: Check if ArgoCD OIDC sealed secrets file exists
      ansible.builtin.stat:
        path: "{{ secrets_base_path }}/services/argocd/secrets/argocd-oidc-sealed.yaml"
      delegate_to: localhost
      become: false
      register: argocd_oidc_sealed_file

    - name: Read ArgoCD OIDC sealed secrets file
      ansible.builtin.slurp:
        src: "{{ secrets_base_path }}/services/argocd/secrets/argocd-oidc-sealed.yaml"
      delegate_to: localhost
      become: false
      register: argocd_oidc_content
      when: argocd_oidc_sealed_file.stat.exists

    - name: Apply ArgoCD OIDC sealed secrets (if exists)
      ansible.builtin.shell: |
        echo '{{ argocd_oidc_content.content | b64decode }}' | /usr/local/bin/k3s kubectl apply -f -
      register: argocd_oidc_result
      changed_when: "'created' in argocd_oidc_result.stdout or 'configured' in argocd_oidc_result.stdout"
      when: argocd_oidc_sealed_file.stat.exists

    - name: Wait for ArgoCD OIDC secret to be decrypted
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get secret argocd-oidc-secret -n {{ argocd_namespace }}
      register: argocd_oidc_wait
      until: argocd_oidc_wait.rc == 0
      retries: 30
      delay: 2
      when: argocd_oidc_sealed_file.stat.exists

    # =========================================================================
    # Verification
    # =========================================================================
    - name: Get Authentik secrets status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get secret authentik-secrets -n {{ authentik_namespace }} -o jsonpath='{.metadata.name}'
      register: authentik_secret_status
      changed_when: false

    - name: Display success message
      ansible.builtin.debug:
        msg:
          - "✅ Authentik secrets applied successfully!"
          - ""
          - "Core Secrets Applied:"
          - "  ✓ authentik-secrets (namespace: {{ authentik_namespace }})"
          - ""
          - "OIDC Secrets Applied:"
          - "  {{ '✓' if grafana_oidc_sealed_file.stat.exists else '⏭ Skipped' }} grafana-oidc-secret (namespace: {{ monitoring_namespace }})"
          - "  {{ '✓' if argocd_oidc_sealed_file.stat.exists else '⏭ Skipped' }} argocd-oidc-secret (namespace: {{ argocd_namespace }})"
          - ""
          - "Next steps:"
          - "  1. Install Authentik: make authentik-install"
          - "  2. Check status: make authentik-status"




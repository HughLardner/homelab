---
# Authelia Secrets Playbook
# Applies sealed secrets for Authelia deployment
#
# Run with: make authelia-secrets
# Or: ansible-playbook -i ansible/inventory/hosts.yml ansible/playbooks/authelia-secrets.yml

- name: Apply Authelia Sealed Secrets
  hosts: k3s_masters[0]
  become: true
  gather_facts: false

  vars:
    authelia_namespace: authelia
    sealed_secrets_path: "{{ playbook_dir }}/../../kubernetes/services/authelia/secrets"

  tasks:
    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          ========================================
          Applying Authelia Sealed Secrets
          ========================================
          Namespace: {{ authelia_namespace }}
          Secrets Path: {{ sealed_secrets_path }}

    # =========================================================================
    # Create Namespace
    # =========================================================================
    - name: Create authelia namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ authelia_namespace }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # =========================================================================
    # Apply Sealed Secrets
    # =========================================================================
    - name: Check if sealed secrets exist
      ansible.builtin.stat:
        path: "{{ sealed_secrets_path }}/authelia-secrets-sealed.yaml"
      register: sealed_secrets_file
      delegate_to: localhost
      become: false

    - name: Copy sealed secrets to node
      ansible.builtin.copy:
        src: "{{ sealed_secrets_path }}/authelia-secrets-sealed.yaml"
        dest: /tmp/authelia-secrets-sealed.yaml
        mode: '0600'
      when: sealed_secrets_file.stat.exists

    - name: Apply sealed secrets
      kubernetes.core.k8s:
        state: present
        src: /tmp/authelia-secrets-sealed.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when: sealed_secrets_file.stat.exists

    - name: Clean up temporary files
      ansible.builtin.file:
        path: /tmp/authelia-secrets-sealed.yaml
        state: absent
      when: sealed_secrets_file.stat.exists

    - name: Wait for secrets to be unsealed
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: authelia-secrets
        namespace: "{{ authelia_namespace }}"
      register: authelia_secret
      until: authelia_secret.resources | length > 0
      retries: 30
      delay: 2
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when: sealed_secrets_file.stat.exists

    # =========================================================================
    # Generate and Add OIDC JWKS RSA Key
    # =========================================================================
    - name: Check if OIDC JWKS key exists in secret
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: authelia-secrets
        namespace: "{{ authelia_namespace }}"
      register: current_secret
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Set JWKS key exists fact
      ansible.builtin.set_fact:
        jwks_key_exists: "{{ (current_secret.resources[0].data['oidc.jwks.RS256.pem'] | default('')) | length > 0 }}"
      when: current_secret.resources | length > 0

    - name: Generate OIDC JWKS RSA key
      ansible.builtin.command:
        cmd: openssl genrsa 4096
      register: rsa_key
      delegate_to: localhost
      become: false
      when: 
        - current_secret.resources | length > 0
        - not (jwks_key_exists | default(false))
      changed_when: true

    - name: Patch secret with OIDC JWKS key
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: authelia-secrets
            namespace: "{{ authelia_namespace }}"
          data:
            oidc.jwks.RS256.pem: "{{ rsa_key.stdout | b64encode }}"
        merge_type: merge
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when:
        - rsa_key is defined
        - rsa_key.stdout is defined
        - rsa_key.stdout | length > 0

    - name: Display JWKS key status
      ansible.builtin.debug:
        msg: "{{ 'OIDC JWKS key already exists' if (jwks_key_exists | default(false)) else 'OIDC JWKS key generated and added' }}"
      when: current_secret.resources | length > 0

    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ========================================
          âœ… Authelia Secrets Applied
          ========================================
          Secrets are now available in the {{ authelia_namespace }} namespace.
          
          Next step: make authelia-install





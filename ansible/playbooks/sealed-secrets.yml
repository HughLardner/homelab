---
# Sealed Secrets Installation Playbook
# Installs sealed-secrets controller for encrypting secrets that can be safely stored in Git

- name: Install Sealed Secrets
  hosts: k3s_masters[0]
  become: true
  gather_facts: true

  vars:
    sealed_secrets_namespace: "kube-system"
    sealed_secrets_release: "sealed-secrets"
    sealed_secrets_chart_version: "2.15.1"
    helm_repo_name: "sealed-secrets"
    helm_repo_url: "https://bitnami-labs.github.io/sealed-secrets"

  pre_tasks:
    - name: Wait for K3s to be ready
      ansible.builtin.command: /usr/local/bin/k3s kubectl get nodes
      register: k3s_status
      changed_when: false
      retries: 10
      delay: 5
      until: k3s_status.rc == 0

    - name: Check if Helm is available
      ansible.builtin.command: which helm
      register: helm_check
      changed_when: false
      failed_when: false

    - name: Install Helm if not present
      ansible.builtin.shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      when: helm_check.rc != 0

  tasks:
    - name: Add sealed-secrets Helm repository
      ansible.builtin.command:
        cmd: helm repo add {{ helm_repo_name }} {{ helm_repo_url }}
      register: repo_add_result
      changed_when: "'has been added' in repo_add_result.stdout"
      failed_when: false
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
      changed_when: false
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Check if sealed-secrets is already installed
      ansible.builtin.command:
        cmd: helm list -n {{ sealed_secrets_namespace }} -o json
      register: helm_list
      changed_when: false
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Parse Helm list output
      ansible.builtin.set_fact:
        sealed_secrets_installed: "{{ (helm_list.stdout | from_json | selectattr('name', 'equalto', sealed_secrets_release) | list | length) > 0 }}"

    - name: Copy values.yaml to remote host
      ansible.builtin.copy:
        src: ../../kubernetes/services/sealed-secrets/values.yaml
        dest: /tmp/sealed-secrets-values.yaml
        mode: '0644'

    - name: Install or upgrade sealed-secrets
      ansible.builtin.command:
        cmd: >
          helm upgrade --install {{ sealed_secrets_release }}
          {{ helm_repo_name }}/sealed-secrets
          --namespace {{ sealed_secrets_namespace }}
          --version {{ sealed_secrets_chart_version }}
          --values /tmp/sealed-secrets-values.yaml
          --wait
          --timeout 10m
      register: helm_install
      changed_when: "'has been upgraded' in helm_install.stdout or 'has been installed' in helm_install.stdout"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Wait for sealed-secrets controller to be ready
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl wait --namespace {{ sealed_secrets_namespace }} --for=condition=ready pod --selector=app.kubernetes.io/name=sealed-secrets --timeout=300s
      register: controller_wait
      changed_when: false
      retries: 3
      delay: 10
      until: controller_wait.rc == 0

    - name: Get controller service
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get svc -n {{ sealed_secrets_namespace }} sealed-secrets-controller -o name
      register: controller_svc
      changed_when: false
      failed_when: false

    - name: Get sealed-secrets public certificate
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get secret -n {{ sealed_secrets_namespace }} -l sealedsecrets.bitnami.com/sealed-secrets-key=active -o yaml
      register: sealing_key
      changed_when: false
      no_log: true

    - name: Save sealing key backup information
      ansible.builtin.copy:
        content: |
          # Sealed Secrets Encryption Key Backup
          # IMPORTANT: Store this file in a secure location (NOT in git!)
          # This key is required to decrypt sealed secrets if the cluster is rebuilt

          To backup the sealing key, run:
          kubectl get secret -n kube-system \
            -l sealedsecrets.bitnami.com/sealed-secrets-key=active \
            -o yaml > sealed-secrets-key-backup.yaml

          To restore the key (before installing sealed-secrets):
          kubectl apply -f sealed-secrets-key-backup.yaml

          Key rotation: Every 30 days (automatic)
        dest: /tmp/sealed-secrets-backup-instructions.txt
        mode: '0644'

    - name: Cleanup temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/sealed-secrets-values.yaml

    - name: Verify sealed-secrets pods are running
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get pods -n {{ sealed_secrets_namespace }} -l app.kubernetes.io/name=sealed-secrets --no-headers
      register: sealed_secrets_status
      changed_when: false
      failed_when: "'Running' not in sealed_secrets_status.stdout"

  post_tasks:
    - name: Build completion message
      ansible.builtin.set_fact:
        completion_message: |

          ==========================================
          âœ… Sealed Secrets Installation Complete!
          ==========================================

          Configuration:
            Namespace: {{ sealed_secrets_namespace }}
            Release: {{ sealed_secrets_release }}
            Chart Version: {{ sealed_secrets_chart_version }}

          Controller Service:
            {{ controller_svc.stdout if controller_svc.rc == 0 else 'sealed-secrets-controller' }}

          Next Steps:

          1. Install kubeseal CLI on your local machine:
             macOS:  brew install kubeseal
             Linux:  See kubernetes/services/sealed-secrets/README.md

          2. Verify installation:
             kubectl get pods -n {{ sealed_secrets_namespace }} -l app.kubernetes.io/name=sealed-secrets
             kubeseal --version

          3. Backup the sealing key (IMPORTANT!):
             kubectl get secret -n kube-system \
               -l sealedsecrets.bitnami.com/sealed-secrets-key=active \
               -o yaml > sealed-secrets-key-backup.yaml
             # Store in a SECURE location (NOT git!)

          4. Create a sealed secret:
             kubectl create secret generic my-secret \
               --from-literal=password=changeme \
               --dry-run=client -o yaml \
               | kubeseal -o yaml > my-sealed-secret.yaml

          5. Commit sealed secret to git:
             git add my-sealed-secret.yaml
             git commit -m "Add my sealed secret"

          Documentation:
            kubernetes/services/sealed-secrets/README.md

          ==========================================

    - name: Display completion message
      ansible.builtin.debug:
        msg: "{{ completion_message.split('\n') }}"

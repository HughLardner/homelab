---
# Authentik SSO Platform Installation Playbook
# Installs Authentik for single sign-on and identity management
#
# Prerequisites:
#   - K3s cluster running
#   - kubectl/helm configured
#   - cert-manager installed (for TLS certificates)
#   - Traefik installed (for ingress)
#   - Longhorn storage (for persistent volumes)
#   - Sealed secrets created (authentik-secrets)
#
# Usage:
#   ansible-playbook playbooks/authentik.yml
#
# Variables (from Terraform via inventory):
#   - authentik_domain: Domain for Authentik UI (required)
#   - authentik_storage_class: Storage class for PVCs (default: longhorn)
#   - authentik_cert_issuer: Cert-manager issuer (default: letsencrypt-prod)

- name: Install Authentik SSO Platform
  hosts: k3s_masters[0]
  become: true
  gather_facts: true

  vars:
    authentik_namespace: authentik
    authentik_helm_repo: https://charts.goauthentik.io
    authentik_helm_chart: authentik
    authentik_helm_version: "2024.10.2" # Latest stable version
    authentik_manifests_path: "{{ playbook_dir }}/../../kubernetes/services/authentik"

  tasks:
    # =========================================================================
    # Pre-flight Checks
    # =========================================================================
    - name: Verify required variables
      ansible.builtin.assert:
        that:
          - authentik_domain is defined and authentik_domain | length > 0
        fail_msg: "Required variable authentik_domain must be set in Terraform configuration"
        success_msg: "All required variables are set"

    - name: Check if Traefik is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get namespace traefik
      register: traefik_ns_check
      changed_when: false
      failed_when: false

    - name: Warn if Traefik not installed
      ansible.builtin.debug:
        msg: "âš ï¸  WARNING: Traefik namespace not found. IngressRoute may not work without Traefik."
      when: traefik_ns_check.rc != 0

    - name: Check if cert-manager is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get namespace cert-manager
      register: certmanager_ns_check
      changed_when: false
      failed_when: false

    - name: Warn if cert-manager not installed
      ansible.builtin.debug:
        msg: "âš ï¸  WARNING: cert-manager namespace not found. TLS certificates may not be issued."
      when: certmanager_ns_check.rc != 0

    # =========================================================================
    # Namespace Setup
    # =========================================================================
    - name: Create Authentik namespace
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl create namespace {{ authentik_namespace }} --dry-run=client -o yaml
      register: namespace_yaml
      changed_when: false

    - name: Apply Authentik namespace
      ansible.builtin.shell: |
        echo '{{ namespace_yaml.stdout }}' | /usr/local/bin/k3s kubectl apply -f -
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"
      register: namespace_result

    # =========================================================================
    # Check for Required Secrets
    # =========================================================================
    - name: Check if Authentik secrets exist
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get secret authentik-secrets -n {{ authentik_namespace }}
      register: secrets_check
      changed_when: false
      failed_when: false

    - name: Fail if secrets are missing
      ansible.builtin.fail:
        msg: |
          âŒ Authentik secrets not found!

          Please create secrets first:
          1. Add authentik-secrets to secrets.yml (see secrets.example.yml)
          2. Run: make seal-secrets
          3. Run: make authentik-secrets
          4. Then run this playbook again
      when: secrets_check.rc != 0

    # =========================================================================
    # Helm Repository Setup
    # =========================================================================
    - name: Add Authentik Helm repository
      kubernetes.core.helm_repository:
        name: authentik
        repo_url: "{{ authentik_helm_repo }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: false

    # =========================================================================
    # Template Helm Values
    # =========================================================================
    - name: Create temporary directory for templated values
      ansible.builtin.tempfile:
        state: directory
        prefix: authentik_
      register: temp_dir

    - name: Template Authentik Helm values
      ansible.builtin.template:
        src: "{{ authentik_manifests_path }}/values.yaml"
        dest: "{{ temp_dir.path }}/values.yaml"
        mode: "0644"

    # =========================================================================
    # Install Authentik via Helm
    # =========================================================================
    - name: Install or upgrade Authentik via Helm
      kubernetes.core.helm:
        name: authentik
        chart_ref: authentik/{{ authentik_helm_chart }}
        chart_version: "{{ authentik_helm_version }}"
        release_namespace: "{{ authentik_namespace }}"
        create_namespace: true
        wait: true
        wait_timeout: 600s
        values_files:
          - "{{ temp_dir.path }}/values.yaml"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # =========================================================================
    # Wait for Authentik Components
    # =========================================================================
    - name: Wait for Authentik server deployment
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/k3s kubectl rollout status deployment/authentik-server
          -n {{ authentik_namespace }} --timeout=300s
      changed_when: false

    - name: Wait for Authentik worker deployment
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/k3s kubectl rollout status deployment/authentik-worker
          -n {{ authentik_namespace }} --timeout=300s
      changed_when: false

    # =========================================================================
    # Apply IngressRoute and Middleware
    # =========================================================================
    - name: Template IngressRoute manifests
      ansible.builtin.template:
        src: "{{ authentik_manifests_path }}/ingressroute.yaml"
        dest: "{{ temp_dir.path }}/ingressroute.yaml"
        mode: "0644"

    - name: Apply IngressRoute for Authentik
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl apply -f {{ temp_dir.path }}/ingressroute.yaml
      register: ingressroute_result
      changed_when: "'created' in ingressroute_result.stdout or 'configured' in ingressroute_result.stdout"

    - name: Template Middleware manifests
      ansible.builtin.template:
        src: "{{ authentik_manifests_path }}/middleware.yaml"
        dest: "{{ temp_dir.path }}/middleware.yaml"
        mode: "0644"

    - name: Apply ForwardAuth Middleware
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl apply -f {{ temp_dir.path }}/middleware.yaml
      register: middleware_result
      changed_when: "'created' in middleware_result.stdout or 'configured' in middleware_result.stdout"

    # =========================================================================
    # Cleanup and Verification
    # =========================================================================
    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent
      when: temp_dir.path is defined

    - name: Get Authentik pods status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get pods -n {{ authentik_namespace }} -o wide
      register: authentik_pods
      changed_when: false

    - name: Get Authentik services
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get svc -n {{ authentik_namespace }}
      register: authentik_svc
      changed_when: false

    - name: Get IngressRoute status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get ingressroute -n {{ authentik_namespace }}
      register: authentik_ingressroute
      changed_when: false

    - name: Get Middleware status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get middleware -n {{ authentik_namespace }}
      register: authentik_middleware
      changed_when: false

    - name: Get certificate status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get certificate -n {{ authentik_namespace }}
      register: authentik_cert
      changed_when: false
      failed_when: false

    # =========================================================================
    # Display Completion Message
    # =========================================================================
    - name: Build completion message
      ansible.builtin.set_fact:
        completion_message: |
          ========================================
          âœ… Authentik SSO Installation Complete!
          ========================================

          ğŸ“Š Pods Status:
          {{ authentik_pods.stdout }}

          ğŸ”— Services:
          {{ authentik_svc.stdout }}

          ğŸŒ IngressRoute:
          {{ authentik_ingressroute.stdout }}

          ğŸ” Middleware:
          {{ authentik_middleware.stdout }}

          ğŸ“œ Certificate:
          {{ authentik_cert.stdout | default('Not found - check cert-manager') }}

          ========================================
          ğŸ”§ Access Points:
          ========================================
          User Portal: https://{{ authentik_domain }}
          Admin UI:    https://{{ authentik_domain }}/if/admin/

          Login with bootstrap credentials from secrets.yml

          ========================================
          ğŸ“š Next Step:
          ========================================
          Run: make authentik-configure
          
          This will configure OIDC providers via API.

          ========================================
          ğŸ”’ Using ForwardAuth Middleware:
          ========================================
          Add to any IngressRoute to protect with SSO:

            middlewares:
              - name: authentik-forward-auth
                namespace: authentik

          ========================================

    - name: Display completion message
      ansible.builtin.debug:
        msg: "{{ completion_message.split('\n') }}"




---
# CoreDNS Local DNS Server Installation Playbook
# Deploys automated local DNS infrastructure with etcd backend
#
# Prerequisites:
#   - K3s cluster running
#   - MetalLB configured with IP pool
#   - Longhorn storage provisioner
#   - kubectl configured
#
# Usage:
#   ansible-playbook playbooks/coredns-local.yml
#
# Components Deployed:
#   - etcd StatefulSet (3 replicas) - DNS record storage
#   - CoreDNS Deployment (2 replicas) - DNS server
#   - External-DNS (CoreDNS provider) - Automatic DNS management
#
# Network Configuration Required After Deployment:
#   Configure router DHCP to use 192.168.10.150 as primary DNS

- name: Install CoreDNS Local DNS Server
  hosts: k3s_masters[0]
  become: true
  gather_facts: true

  vars:
    coredns_local_namespace: coredns-local
    external_dns_local_namespace: external-dns-local
    coredns_manifests_path: "{{ playbook_dir }}/../../kubernetes/services/coredns-local"
    external_dns_local_manifests_path: "{{ playbook_dir }}/../../kubernetes/services/external-dns-local"
    external_dns_local_app_path: "{{ playbook_dir }}/../../kubernetes/applications/external-dns-local"

  tasks:
    # =========================================================================
    # Pre-flight Checks
    # =========================================================================
    - name: Check if MetalLB is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get namespace metallb-system
      register: metallb_check
      changed_when: false
      failed_when: false

    - name: Fail if MetalLB not installed
      ansible.builtin.fail:
        msg: "MetalLB is required for LoadBalancer support. Run 'make metallb-install' first."
      when: metallb_check.rc != 0

    - name: Check if Longhorn is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get storageclass longhorn
      register: longhorn_check
      changed_when: false
      failed_when: false

    - name: Fail if Longhorn not installed
      ansible.builtin.fail:
        msg: "Longhorn storage is required for etcd persistence. Run 'make longhorn-install' first."
      when: longhorn_check.rc != 0

    # =========================================================================
    # Deploy CoreDNS Infrastructure
    # =========================================================================
    - name: Create coredns-local namespace
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Namespace
        metadata:
          name: {{ coredns_local_namespace }}
          labels:
            name: {{ coredns_local_namespace }}
            app.kubernetes.io/component: dns
            app.kubernetes.io/part-of: homelab-infrastructure
        EOF
      register: namespace_result
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"

    - name: Apply etcd services
      ansible.builtin.shell: |
        cat <<'EOF' | /usr/local/bin/k3s kubectl apply -f -
        {{ lookup('file', coredns_manifests_path + '/etcd/service-headless.yaml') }}
        ---
        {{ lookup('file', coredns_manifests_path + '/etcd/service-client.yaml') }}
        EOF
      register: etcd_svc_result
      changed_when: "'created' in etcd_svc_result.stdout or 'configured' in etcd_svc_result.stdout"

    - name: Apply etcd StatefulSet
      ansible.builtin.shell: |
        cat <<'EOF' | /usr/local/bin/k3s kubectl apply -f -
        {{ lookup('file', coredns_manifests_path + '/etcd/statefulset.yaml') }}
        EOF
      register: etcd_sts_result
      changed_when: "'created' in etcd_sts_result.stdout or 'configured' in etcd_sts_result.stdout"

    - name: Apply CoreDNS RBAC
      ansible.builtin.shell: |
        cat <<'EOF' | /usr/local/bin/k3s kubectl apply -f -
        {{ lookup('file', coredns_manifests_path + '/coredns/rbac.yaml') }}
        EOF
      register: coredns_rbac_result
      changed_when: "'created' in coredns_rbac_result.stdout or 'configured' in coredns_rbac_result.stdout"

    - name: Apply CoreDNS ConfigMap
      ansible.builtin.shell: |
        cat <<'EOF' | /usr/local/bin/k3s kubectl apply -f -
        {{ lookup('file', coredns_manifests_path + '/coredns/configmap.yaml') }}
        EOF
      register: coredns_cm_result
      changed_when: "'created' in coredns_cm_result.stdout or 'configured' in coredns_cm_result.stdout"

    - name: Apply CoreDNS Deployment
      ansible.builtin.shell: |
        cat <<'EOF' | /usr/local/bin/k3s kubectl apply -f -
        {{ lookup('file', coredns_manifests_path + '/coredns/deployment.yaml') }}
        EOF
      register: coredns_deploy_result
      changed_when: "'created' in coredns_deploy_result.stdout or 'configured' in coredns_deploy_result.stdout"

    - name: Apply CoreDNS Service
      ansible.builtin.shell: |
        cat <<'EOF' | /usr/local/bin/k3s kubectl apply -f -
        {{ lookup('file', coredns_manifests_path + '/coredns/service.yaml') }}
        EOF
      register: coredns_svc_result
      changed_when: "'created' in coredns_svc_result.stdout or 'configured' in coredns_svc_result.stdout"

    - name: Wait for etcd StatefulSet to be ready
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl rollout status statefulset/coredns-etcd -n {{ coredns_local_namespace }} --timeout=300s
      changed_when: false
      register: etcd_rollout

    - name: Wait for etcd pods to be ready
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl wait --for=condition=ready pod -l app=coredns-etcd -n {{ coredns_local_namespace }} --timeout=300s
      changed_when: false

    - name: Check etcd cluster health
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl exec -n {{ coredns_local_namespace }} coredns-etcd-0 -- \
          etcdctl endpoint health --cluster
      register: etcd_health
      changed_when: false
      failed_when: false

    - name: Display etcd cluster health
      ansible.builtin.debug:
        msg: "{{ etcd_health.stdout_lines }}"
      when: etcd_health.rc == 0

    - name: Wait for CoreDNS deployment to be ready
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl rollout status deployment/coredns -n {{ coredns_local_namespace }} --timeout=300s
      changed_when: false

    - name: Wait for CoreDNS LoadBalancer IP
      ansible.builtin.shell: |
        for i in {1..60}; do
          IP=$(/usr/local/bin/k3s kubectl get svc coredns -n {{ coredns_local_namespace }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)
          if [ -n "$IP" ]; then
            echo "$IP"
            exit 0
          fi
          sleep 5
        done
        echo "Timeout waiting for LoadBalancer IP"
        exit 1
      register: coredns_lb_ip
      changed_when: false

    # =========================================================================
    # Deploy External-DNS (CoreDNS Provider)
    # =========================================================================
    - name: Check if ArgoCD is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get namespace argocd
      register: argocd_check
      changed_when: false
      failed_when: false

    - name: Deploy external-dns-local via ArgoCD Application
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl apply -f {{ external_dns_local_app_path }}/application.yaml
      register: external_dns_app
      changed_when: "'created' in external_dns_app.stdout or 'configured' in external_dns_app.stdout"
      when: argocd_check.rc == 0

    - name: Wait for external-dns-local deployment (if ArgoCD available)
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl rollout status deployment/external-dns-local -n {{ external_dns_local_namespace }} --timeout=300s
      changed_when: false
      failed_when: false
      when: argocd_check.rc == 0

    # =========================================================================
    # Verification
    # =========================================================================
    - name: Get CoreDNS pods
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get pods -n {{ coredns_local_namespace }} -o wide
      register: coredns_pods
      changed_when: false

    - name: Get CoreDNS service
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get svc -n {{ coredns_local_namespace }}
      register: coredns_svc
      changed_when: false

    - name: Get external-dns-local pods
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get pods -n {{ external_dns_local_namespace }}
      register: external_dns_pods
      changed_when: false
      failed_when: false

    - name: Test DNS query
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl run -it --rm dnstest --image=busybox --restart=Never -- \
          nslookup kubernetes.default.svc.cluster.local {{ coredns_lb_ip.stdout }} || true
      register: dns_test
      changed_when: false
      failed_when: false

    # =========================================================================
    # Display Completion Message
    # =========================================================================
    - name: Build completion message
      ansible.builtin.set_fact:
        completion_message: |
          ========================================
          ‚úÖ CoreDNS Local DNS Server Installed!
          ========================================

          üìä CoreDNS Status:
          {{ coredns_svc.stdout }}

          üì¶ CoreDNS Pods:
          {{ coredns_pods.stdout }}

          üì¶ External-DNS Pods:
          {{ external_dns_pods.stdout if external_dns_pods.rc == 0 else 'Not deployed (ArgoCD not available)' }}

          üåê DNS Server IP: {{ coredns_lb_ip.stdout }}

          ========================================
          üìù IMPORTANT: Configure Your Router
          ========================================
          To use the local DNS server, configure your router/DHCP:

          Primary DNS:   {{ coredns_lb_ip.stdout }}
          Secondary DNS: 1.1.1.1

          DHCP Option 6 (DNS Server):
          - Primary: {{ coredns_lb_ip.stdout }}
          - Secondary: 1.1.1.1

          ========================================
          üß™ Testing DNS Resolution
          ========================================
          From your local machine:

          # Test DNS query
          nslookup argocd.silverseekers.org {{ coredns_lb_ip.stdout }}

          # Or using dig
          dig @{{ coredns_lb_ip.stdout }} argocd.silverseekers.org

          ========================================
          üìã Next Steps:
          ========================================
          1. Configure your router to use {{ coredns_lb_ip.stdout }} as primary DNS

          2. Verify DNS is working:
             make coredns-local-test

          3. Check component status:
             make coredns-local-status

          4. View logs:
             make coredns-local-logs

          5. Monitor external-dns operations:
             kubectl logs -n external-dns-local -l app.kubernetes.io/name=external-dns -f

          ========================================
          üîç Inspecting etcd Records
          ========================================
          # Open etcd shell
          kubectl exec -it -n {{ coredns_local_namespace }} coredns-etcd-0 -- sh

          # List all DNS records
          etcdctl get /skydns --prefix --keys-only

          # Get specific record
          etcdctl get /skydns/org/silverseekers/argocd

          ========================================
          üìö Documentation:
          ========================================
          See kubernetes/services/coredns-local/README.md for:
          - Architecture details
          - Troubleshooting guide
          - HA configuration
          - Monitoring setup

          ========================================

    - name: Display completion message
      ansible.builtin.debug:
        msg: "{{ completion_message.split('\n') }}"

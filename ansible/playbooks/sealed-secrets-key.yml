---
# Sealed Secrets Key Backup and Restore
# Preserves encryption keys across cluster rebuilds so sealed secrets remain decryptable
#
# Usage:
#   Backup:  ansible-playbook playbooks/sealed-secrets-key.yml -e key_action=backup
#   Restore: ansible-playbook playbooks/sealed-secrets-key.yml -e key_action=restore
#   List:    ansible-playbook playbooks/sealed-secrets-key.yml -e key_action=list
#
# IMPORTANT: The backup file contains private keys - keep it secure and never commit to git!
#
# Workflow for cluster rebuilds:
#   1. Before destroy: make sealed-secrets-backup
#   2. After rebuild:  make sealed-secrets-restore (BEFORE sealed-secrets-install)
#   3. Then install:   make sealed-secrets-install
#   4. Existing sealed secrets will decrypt correctly

- name: Sealed Secrets Key Management
  hosts: localhost
  connection: local
  gather_facts: false
  become: false

  vars:
    backup_file: "{{ playbook_dir }}/../../sealed-secrets-key-backup.yaml"
    sealed_secrets_namespace: "kube-system"

  tasks:
    # =========================================================================
    # BACKUP TASKS
    # =========================================================================
    - name: Backup - Export all sealing keys
      ansible.builtin.shell: |
        kubectl get secret -n {{ sealed_secrets_namespace }} \
          -l sealedsecrets.bitnami.com/sealed-secrets-key \
          -o yaml
      register: keys_export
      when: key_action == "backup"
      changed_when: false

    - name: Backup - Check if keys were found
      ansible.builtin.fail:
        msg: |
          No sealed-secrets keys found in cluster!
          
          Make sure sealed-secrets is installed:
            make sealed-secrets-install
      when: 
        - key_action == "backup"
        - 'keys_export.stdout == "" or "items: []" in keys_export.stdout'

    - name: Backup - Write backup file
      ansible.builtin.copy:
        content: |
          # Sealed Secrets Key Backup
          # Generated: {{ lookup('pipe', 'date -u +%Y-%m-%dT%H:%M:%SZ') }}
          # WARNING: This file contains PRIVATE KEYS - DO NOT COMMIT TO GIT!
          #
          # To restore: make sealed-secrets-restore
          # Must be restored BEFORE installing sealed-secrets controller
          #
          {{ keys_export.stdout }}
        dest: "{{ backup_file }}"
        mode: '0600'
      when: key_action == "backup"

    - name: Backup - Count keys
      ansible.builtin.shell: |
        echo "{{ keys_export.stdout }}" | grep -c "name: sealed-secrets-key" || echo "0"
      register: key_count
      when: key_action == "backup"
      changed_when: false

    - name: Backup - Show summary
      ansible.builtin.debug:
        msg: |
          ✅ Sealed Secrets key backup completed!
          
          Backup file: {{ backup_file }}
          Keys backed up: {{ key_count.stdout | trim }}
          
          ⚠️  This file contains PRIVATE encryption keys!
          ⚠️  Store it securely and ensure it stays in .gitignore
          
          Restore workflow:
            1. Rebuild cluster
            2. make sealed-secrets-restore  ← BEFORE installing sealed-secrets!
            3. make sealed-secrets-install
            4. Existing sealed secrets will work
      when: key_action == "backup"

    # =========================================================================
    # RESTORE TASKS
    # =========================================================================
    - name: Restore - Check if backup file exists
      ansible.builtin.stat:
        path: "{{ backup_file }}"
      register: backup_stat
      when: key_action == "restore"

    - name: Restore - Fail if no backup exists
      ansible.builtin.fail:
        msg: |
          No backup file found at {{ backup_file }}
          
          Run 'make sealed-secrets-backup' first to create a backup,
          or obtain a backup from a previous cluster.
      when: key_action == "restore" and not backup_stat.stat.exists

    - name: Restore - Ensure namespace exists
      ansible.builtin.shell: |
        kubectl create namespace {{ sealed_secrets_namespace }} --dry-run=client -o yaml | kubectl apply -f -
      when: key_action == "restore" and backup_stat.stat.exists
      changed_when: false
      failed_when: false

    - name: Restore - Check if sealed-secrets is already installed
      ansible.builtin.shell: |
        kubectl get deployment -n {{ sealed_secrets_namespace }} sealed-secrets-controller 2>/dev/null || echo "not-found"
      register: controller_check
      when: key_action == "restore" and backup_stat.stat.exists
      changed_when: false

    - name: Restore - Warn if controller already exists
      ansible.builtin.debug:
        msg: |
          ⚠️  WARNING: Sealed-secrets controller is already running!
          
          The controller may have generated new keys. For best results:
          1. Delete the controller: kubectl delete deployment sealed-secrets-controller -n kube-system
          2. Delete existing keys: kubectl delete secret -n kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key
          3. Re-run: make sealed-secrets-restore
          4. Re-install: make sealed-secrets-install
          
          Proceeding anyway - the controller will pick up the restored keys on restart...
      when: 
        - key_action == "restore" 
        - backup_stat.stat.exists
        - "'not-found' not in controller_check.stdout"

    - name: Restore - Apply backup keys
      ansible.builtin.shell: |
        kubectl apply -f "{{ backup_file }}" 2>&1
      register: restore_result
      when: key_action == "restore" and backup_stat.stat.exists

    - name: Restore - Restart controller if running
      ansible.builtin.shell: |
        kubectl rollout restart deployment sealed-secrets-controller -n {{ sealed_secrets_namespace }} 2>/dev/null || true
      when: 
        - key_action == "restore" 
        - backup_stat.stat.exists
        - "'not-found' not in controller_check.stdout"
      changed_when: false

    - name: Restore - Show summary
      ansible.builtin.debug:
        msg: |
          ✅ Sealed Secrets key restore completed!
          
          {{ restore_result.stdout | default('Keys restored') }}
          
          Next steps:
          {% if 'not-found' in controller_check.stdout %}
          1. Install sealed-secrets: make sealed-secrets-install
          2. The controller will use the restored keys
          3. Existing sealed secrets will decrypt correctly
          {% else %}
          The controller was restarted to pick up the restored keys.
          Existing sealed secrets should now decrypt correctly.
          {% endif %}
      when: key_action == "restore" and backup_stat.stat.exists

    # =========================================================================
    # LIST TASKS
    # =========================================================================
    - name: List - Get current sealing keys
      ansible.builtin.shell: |
        echo "=== Sealing Keys in Cluster ==="
        kubectl get secrets -n {{ sealed_secrets_namespace }} -l sealedsecrets.bitnami.com/sealed-secrets-key -o wide 2>/dev/null || echo "No keys found or cluster not accessible"
        echo ""
        echo "=== Active Key ==="
        kubectl get secrets -n {{ sealed_secrets_namespace }} -l sealedsecrets.bitnami.com/sealed-secrets-key=active -o name 2>/dev/null || echo "No active key found"
        echo ""
        echo "=== Controller Status ==="
        kubectl get deployment -n {{ sealed_secrets_namespace }} sealed-secrets-controller -o wide 2>/dev/null || echo "Controller not installed"
      register: cluster_status
      when: key_action == "list"
      changed_when: false
      failed_when: false

    - name: List - Check backup file
      ansible.builtin.stat:
        path: "{{ backup_file }}"
      register: backup_file_stat
      when: key_action == "list"

    - name: List - Build backup status
      ansible.builtin.set_fact:
        backup_status_lines: |
          
          === Local Backup Status ===
          {% if backup_file_stat.stat.exists %}
          Backup file: {{ backup_file }}
          Size: {{ backup_file_stat.stat.size }} bytes
          Modified: {{ '%Y-%m-%d %H:%M:%S' | strftime(backup_file_stat.stat.mtime) }}
          {% else %}
          No backup file found.
          Run 'make sealed-secrets-backup' to create one.
          {% endif %}
      when: key_action == "list"

    - name: List - Display status
      ansible.builtin.debug:
        msg: "{{ (cluster_status.stdout_lines + backup_status_lines.split('\n')) | select() | list }}"
      when: key_action == "list"


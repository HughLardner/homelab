---
# ArgoCD GitOps Platform Installation Playbook
# Installs ArgoCD for continuous delivery and GitOps
#
# Prerequisites:
#   - K3s cluster running
#   - kubectl/helm configured
#   - cert-manager installed (for TLS certificates)
#   - Traefik installed (for ingress)
#
# Usage:
#   ansible-playbook playbooks/argocd.yml
#
# Variables (from Terraform via inventory):
#   - argocd_domain: Domain for ArgoCD UI (required)
#   - argocd_password: Admin password (required)
#   - argocd_replicas: Server replicas (default: 1)
#   - argocd_cert_issuer: Cert-manager issuer (default: letsencrypt-staging)

- name: Install ArgoCD GitOps Platform
  hosts: k3s_masters[0]
  become: true
  gather_facts: true

  vars_files:
    - "{{ playbook_dir }}/../../config/homelab.yaml"
    - "{{ playbook_dir }}/../../config/secrets.yml"

  vars:
    argocd_namespace: argocd
    argocd_helm_repo: https://argoproj.github.io/argo-helm
    argocd_helm_chart: argo-cd
    argocd_helm_version: "7.7.10"  # Latest stable version
    argocd_manifests_path: "{{ playbook_dir }}/../../kubernetes/services/argocd"
    # Variables loaded from config/homelab.yaml via vars_files
    argocd_domain: "{{ services.argocd.domain }}"
    argocd_cert_issuer: "{{ services.argocd.cert_issuer | default(global.cert_issuer) }}"
    argocd_replicas: "{{ services.argocd.replicas | default(1) }}"
    # argocd_password is loaded directly from config/secrets.yml via vars_files

  tasks:
    # =========================================================================
    # Pre-flight Checks
    # =========================================================================
    - name: Verify required variables
      ansible.builtin.assert:
        that:
          - argocd_domain is defined and argocd_domain | length > 0
          - argocd_password is defined and argocd_password | length > 0
        fail_msg: "Required variables argocd_domain and argocd_password must be set"
        success_msg: "All required variables are set"

    - name: Check if Traefik IngressRoute CRD is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get crd ingressroutes.traefik.io
      register: traefik_crd_check
      changed_when: false
      failed_when: false

    - name: Check if cert-manager Certificate CRD is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get crd certificates.cert-manager.io
      register: certmanager_crd_check
      changed_when: false
      failed_when: false

    - name: Check if SealedSecrets CRD is installed
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get crd sealedsecrets.bitnami.com
      register: sealedsecrets_crd_check
      changed_when: false
      failed_when: false

    - name: Set CRD availability facts
      ansible.builtin.set_fact:
        ingress_crds_available: "{{ traefik_crd_check.rc == 0 and certmanager_crd_check.rc == 0 }}"
        sealedsecrets_crd_available: "{{ sealedsecrets_crd_check.rc == 0 }}"

    - name: Display CRD availability status
      ansible.builtin.debug:
        msg: |
          CRD Availability:
            Traefik IngressRoute: {{ 'available' if traefik_crd_check.rc == 0 else 'NOT FOUND' }}
            cert-manager Certificate: {{ 'available' if certmanager_crd_check.rc == 0 else 'NOT FOUND' }}
            SealedSecrets: {{ 'available' if sealedsecrets_crd_check.rc == 0 else 'NOT FOUND' }}

    # =========================================================================
    # Namespace Setup
    # =========================================================================
    - name: Create ArgoCD namespace
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml
      register: namespace_yaml
      changed_when: false

    - name: Apply ArgoCD namespace
      ansible.builtin.shell: |
        echo '{{ namespace_yaml.stdout }}' | /usr/local/bin/k3s kubectl apply -f -
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"
      register: namespace_result

    # =========================================================================
    # Helm Repository Setup
    # =========================================================================
    - name: Add ArgoCD Helm repository
      kubernetes.core.helm_repository:
        name: argo
        repo_url: "{{ argocd_helm_repo }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: false

    # =========================================================================
    # Generate ArgoCD Admin Password Hash
    # =========================================================================
    - name: Generate bcrypt hash for admin password
      ansible.builtin.shell: |
        htpasswd -nbBC 10 "" '{{ argocd_password }}' | tr -d ':\n' | sed 's/$2y/$2a/'
      register: argocd_password_hash
      changed_when: false
      no_log: true

    # =========================================================================
    # Template Helm Values
    # =========================================================================
    - name: Create temporary directory for templated values
      ansible.builtin.tempfile:
        state: directory
        prefix: argocd_
      register: temp_dir

    - name: Template ArgoCD Helm values
      ansible.builtin.template:
        src: "{{ argocd_manifests_path }}/values.yaml"
        dest: "{{ temp_dir.path }}/values.yaml"
        mode: "0644"

    # =========================================================================
    # Install ArgoCD via Helm
    # =========================================================================
    - name: Install or upgrade ArgoCD via Helm
      kubernetes.core.helm:
        name: argocd
        chart_ref: argo/{{ argocd_helm_chart }}
        chart_version: "{{ argocd_helm_version }}"
        release_namespace: "{{ argocd_namespace }}"
        create_namespace: true
        wait: true
        wait_timeout: 600s
        values_files:
          - "{{ temp_dir.path }}/values.yaml"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    # =========================================================================
    # Configure TLS Trust for Let's Encrypt Staging
    # =========================================================================
    # ArgoCD needs to trust the Let's Encrypt staging CA when connecting to
    # OIDC providers (like Authelia) using staging certificates
    - name: Check if using staging certificates
      ansible.builtin.set_fact:
        use_staging_certs: "{{ (argocd_cert_issuer | default('letsencrypt-staging')) == 'letsencrypt-staging' or (authelia_cert_issuer | default('letsencrypt-staging')) == 'letsencrypt-staging' }}"

    - name: Get Authelia domain for TLS trust
      ansible.builtin.set_fact:
        authelia_oidc_domain: "{{ authelia_domain | default('auth.silverseekers.org') }}"

    # Let's Encrypt Staging Root CA - "(STAGING) Pretend Pear X1"
    # https://letsencrypt.org/docs/staging-environment/
    - name: Set Let's Encrypt staging CA certificate
      ansible.builtin.set_fact:
        letsencrypt_staging_ca: |
          -----BEGIN CERTIFICATE-----
          MIIFmDCCA4CgAwIBAgIQU9C87nMpOIFKYpfvOHFHFDANBgkqhkiG9w0BAQsFADBm
          MQswCQYDVQQGEwJVUzEzMDEGA1UEChMqKFNUQUdJTkcpIEludGVybmV0IFNlY3Vy
          aXR5IFJlc2VhcmNoIEdyb3VwMSIwIAYDVQQDExkoU1RBR0lORykgUHJldGVuZCBQ
          ZWFyIFgxMB4XDTE1MDYwNDExMDQzOFoXDTM1MDYwNDExMDQzOFowZjELMAkGA1UE
          BhMCVVMxMzAxBgNVBAoTKihTVEFHSU5HKSBJbnRlcm5ldCBTZWN1cml0eSBSZXNl
          YXJjaCBHcm91cDEiMCAGA1UEAxMZKFNUQUdJTkcpIFByZXRlbmQgUGVhciBYMTCC
          AiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBALbagEdDTa1QgGBWSYkyMhsc
          ZXENOBaVRTMX1hceJENgsL0Ma49D3MilI4KS38mtkmdF6cPWnL++fgehT0FbRHZg
          jOEr8UAN4jH6VVXmo304v4HKWBaRCSQ+WJUbRlZMPd4gakb7jQr2BI8GsA3RJX2R
          bKqo7a+wLA0GR9qn/r/ABPXjwwI6+W9/4wXDPHPyRNBl0xAT/cSfLD9MLLGdSN1r
          EJe8rKgcPEfJWi7jVmXVAV9VplVD4WJTjEvdgyFvMjNd9K0f0owa2DFXLMi2nvnW
          lbF9F0kLMbJpYAN0FHMkl7iq1uMqf8MOMDQpwW4NKl5bDbKxCNCALgAEJP2XFXEB
          LJhWtHl+RLdfHUlWpvvWpcoPrL3e7lcZS4FQJmMBbMPhHYe0n/qDd/gdLRuTjZ2j
          W60ikdHBrL02pZgLb3M2RdNoMgI0AEn8+u7OqONlMBSeqwJjN+f8UgSh+Uqv9YyR
          KEBfv/O1mXKLIJa2Xq4dTJEHv6qHkqz4vUxlljzIYbmMV6Y0bP0Mi2wGBaAZHmb6
          UHBPjFoGNi3jhMXvJ8Snn+8gPAG3BsM9fOWFVzwMQi8t6hjL8DPfaV9AJkUT4l78
          IqBRVF27G4nHrdC1TrfFYxJfVOL6Y/aemR8AS+2K5l0rJPka3FAoacBb/NX9pba/
          RA6lFlhT3LLVLk1ppnILAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNVHRMB
          Af8EBTADAQH/MB0GA1UdDgQWBBS182Xy/rAKkh/7PH3zRKCsYyXDFDANBgkqhkiG
          9w0BAQsFAAOCAgEAncDZNytDbrrVe68UT6py1lfF2h6Tm2p8ro42i87WWyP2LK8Y
          nLHC0hvNfWeWmjZQYBQfGC5c7aQRezak+tHLdmrNKHkn5kn+9E9LCjCaEsyIIn2j
          qdHlAkepu/C3KnNtVx5tW07e5bvIjJScwkCDbP3akWQixPpRFAsnP+ULx7k0aO1x
          qAeaAhQ2rgo1F58hcflgqKTXnpPM02intVfiVVkX5GXpJjK5EoQtLceyGOrkxlM/
          sTPq4UrnypmsqSagWV3HcUlYtDinc+nukFk6eR4XkzXBbwKOCQ0Y04cGE0T44Ej8
          2PB4VHCz4RBhb5b8D0U7GBrHtNgWy7nAScpC+PQn1H5qlkSFD7sV2l8aBOvCMoD4
          1jN/J8A4LAVSprqvMdIL94xvt2kMP9T1u4fwTFD+ABeNJLnBF8s1lbvJ4UwZxVMh
          /Lna+5k/5l3T6PCMTHrFrBjVotGNhvWm1mFv4TtWBWuk5vlYJEBl95ML9E2JNlrM
          +ysOxaMLVAkZlvBjMkr2YODC3PR+WlDgOTnYjg6BFbjW3LUALQF4RhvruPF0AJ8g
          A0nEjgS8qR/uYWUFlNz/1T6yUlUvV8M9VlDfEP9p9RLf2fG9G3/xq2h56eZSLfCX
          9Q2UnNslxDqo9phK5YRhz6RXgvqg5tbVBMb1I/JAz5OnNgG1mCzRgHlffaw=
          -----END CERTIFICATE-----
      when: use_staging_certs | bool

    - name: Build TLS certs ConfigMap data
      ansible.builtin.set_fact:
        tls_certs_data: "{{ {authelia_oidc_domain: letsencrypt_staging_ca} }}"
      when: use_staging_certs | bool

    - name: Configure ArgoCD to trust Let's Encrypt staging CA
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: argocd-tls-certs-cm
            namespace: "{{ argocd_namespace }}"
          data: "{{ tls_certs_data }}"
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      register: tls_certs_cm_result
      when: use_staging_certs | bool

    - name: Display TLS trust configuration status
      ansible.builtin.debug:
        msg: "{{ 'Configured ArgoCD to trust Lets Encrypt staging CA for ' + authelia_oidc_domain if use_staging_certs else 'Using production certificates - no staging CA trust needed' }}"

    - name: Restart ArgoCD server to pick up TLS trust config
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl rollout restart deployment/argocd-server -n {{ argocd_namespace }}
      register: argocd_restart
      changed_when: "'restarted' in argocd_restart.stdout"
      when: use_staging_certs | bool and tls_certs_cm_result is changed

    - name: Wait for ArgoCD server restart to complete
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl rollout status deployment/argocd-server -n {{ argocd_namespace }} --timeout=120s
      changed_when: false
      when: use_staging_certs | bool and tls_certs_cm_result is changed

    # =========================================================================
    # Set Admin Password
    # =========================================================================
    - name: Get current time for password modification time
      ansible.builtin.set_fact:
        password_mtime: "{{ ansible_date_time.iso8601 }}"

    - name: Update ArgoCD admin password
      ansible.builtin.shell: |
        /usr/local/bin/k3s kubectl -n {{ argocd_namespace }} patch secret argocd-secret \
          -p '{"stringData": {
            "admin.password": "{{ argocd_password_hash.stdout }}",
            "admin.passwordMtime": "{{ password_mtime }}"
          }}'
      no_log: true
      register: password_update
      changed_when: "'patched' in password_update.stdout"

    # =========================================================================
    # Apply ArgoCD OIDC Sealed Secret (requires SealedSecrets CRD)
    # =========================================================================
    - name: Check if ArgoCD OIDC sealed secret exists
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/../../kubernetes/services/argocd/secrets/argocd-oidc-sealed.yaml"
      register: argocd_oidc_sealed
      delegate_to: localhost
      become: false

    - name: Skip OIDC sealed secret if CRD not available
      ansible.builtin.debug:
        msg: |
          ‚è≠Ô∏è  Skipping OIDC SealedSecret - SealedSecrets CRD not yet installed.
          Run this playbook again after 'make sealed-secrets-install' to apply OIDC secrets.
      when: argocd_oidc_sealed.stat.exists and not (sealedsecrets_crd_available | default(false))

    - name: Copy ArgoCD OIDC sealed secret to node
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../kubernetes/services/argocd/secrets/argocd-oidc-sealed.yaml"
        dest: /tmp/argocd-oidc-sealed.yaml
        mode: '0600'
      when: argocd_oidc_sealed.stat.exists and (sealedsecrets_crd_available | default(false))

    - name: Apply ArgoCD OIDC sealed secret
      kubernetes.core.k8s:
        state: present
        src: /tmp/argocd-oidc-sealed.yaml
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when: argocd_oidc_sealed.stat.exists and (sealedsecrets_crd_available | default(false))

    - name: Clean up OIDC sealed secret temp file
      ansible.builtin.file:
        path: /tmp/argocd-oidc-sealed.yaml
        state: absent
      when: argocd_oidc_sealed.stat.exists and (sealedsecrets_crd_available | default(false))

    - name: Wait for ArgoCD OIDC secret to be unsealed
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: argocd-oidc-secret
        namespace: "{{ argocd_namespace }}"
      register: argocd_oidc_secret
      until: argocd_oidc_secret.resources | length > 0
      retries: 30
      delay: 2
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      when: argocd_oidc_sealed.stat.exists and (sealedsecrets_crd_available | default(false))

    - name: Copy OIDC client secret to main argocd-secret
      ansible.builtin.shell: |
        OIDC_SECRET=$(/usr/local/bin/k3s kubectl get secret argocd-oidc-secret -n {{ argocd_namespace }} -o jsonpath='{.data.oidc\.authelia\.clientSecret}')
        /usr/local/bin/k3s kubectl patch secret argocd-secret -n {{ argocd_namespace }} --type='json' \
          -p="[{\"op\": \"add\", \"path\": \"/data/oidc.authelia.clientSecret\", \"value\": \"$OIDC_SECRET\"}]"
      register: oidc_patch
      changed_when: "'patched' in oidc_patch.stdout"
      when: argocd_oidc_sealed.stat.exists and (sealedsecrets_crd_available | default(false))

    # =========================================================================
    # Wait for ArgoCD Components
    # =========================================================================
    - name: Wait for ArgoCD server deployment
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/k3s kubectl rollout status deployment/argocd-server
          -n {{ argocd_namespace }} --timeout=300s
      changed_when: false

    - name: Wait for ArgoCD application controller
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/k3s kubectl rollout status statefulset/argocd-application-controller
          -n {{ argocd_namespace }} --timeout=300s
      changed_when: false

    - name: Wait for ArgoCD repo server
      ansible.builtin.command:
        cmd: >
          /usr/local/bin/k3s kubectl rollout status deployment/argocd-repo-server
          -n {{ argocd_namespace }} --timeout=300s
      changed_when: false

    # =========================================================================
    # Apply IngressRoute for TLS Access (requires Traefik + cert-manager CRDs)
    # =========================================================================
    - name: Skip IngressRoute if CRDs not available
      ansible.builtin.debug:
        msg: |
          ‚è≠Ô∏è  Skipping IngressRoute configuration - required CRDs not yet installed.
          Traefik CRD: {{ 'available' if traefik_crd_check.rc == 0 else 'NOT FOUND' }}
          cert-manager CRD: {{ 'available' if certmanager_crd_check.rc == 0 else 'NOT FOUND' }}
          Run this playbook again after Traefik and cert-manager are installed.
      when: not (ingress_crds_available | default(false))

    - name: Deploy ArgoCD Ingress resources via Helm
      ansible.builtin.command:
        cmd: >
          helm upgrade --install argocd-ingress
          {{ argocd_manifests_path }}
          --namespace {{ argocd_namespace }}
          --values {{ playbook_dir }}/../../config/homelab.yaml
          --wait
          --timeout=5m
      environment:
        KUBECONFIG: "{{ lookup('env', 'HOME') }}/.kube/config-homelab"
      delegate_to: localhost
      become: false
      when: ingress_crds_available | default(false)
      register: argocd_ingress_result
      changed_when: "'has been upgraded' in argocd_ingress_result.stdout or 'has been installed' in argocd_ingress_result.stdout"

    # =========================================================================
    # Configure Repository Connection
    # =========================================================================
    - name: Check if GitHub repository URL is configured
      ansible.builtin.set_fact:
        github_repo_configured: "{{ argocd_github_repo_url is defined and argocd_github_repo_url | length > 0 and argocd_github_token is defined and argocd_github_token | length > 0 }}"

    - name: Template repository configuration
      ansible.builtin.template:
        src: "{{ argocd_manifests_path }}/repository.yaml"
        dest: "{{ temp_dir.path }}/repository.yaml"
        mode: "0600"
      when: github_repo_configured | bool
      no_log: true

    - name: Apply repository connection
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl apply -f {{ temp_dir.path }}/repository.yaml
      register: repository_result
      changed_when: "'created' in repository_result.stdout or 'configured' in repository_result.stdout"
      when: github_repo_configured | bool

    - name: Display repository connection status
      ansible.builtin.debug:
        msg: "{{ 'Repository connection configured for: ' + argocd_github_repo_url if github_repo_configured else 'Skipping repository configuration (no GitHub URL/token provided)' }}"

    # =========================================================================
    # Cleanup and Verification
    # =========================================================================
    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent
      when: temp_dir.path is defined

    - name: Get ArgoCD pods status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get pods -n {{ argocd_namespace }} -o wide
      register: argocd_pods
      changed_when: false

    - name: Get ArgoCD services
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get svc -n {{ argocd_namespace }}
      register: argocd_svc
      changed_when: false

    - name: Get IngressRoute status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get ingressroute -n {{ argocd_namespace }}
      register: argocd_ingressroute
      changed_when: false
      failed_when: false
      when: ingress_crds_available | default(false)

    - name: Get certificate status
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s kubectl get certificate -n {{ argocd_namespace }}
      register: argocd_cert
      changed_when: false
      failed_when: false
      when: ingress_crds_available | default(false)

    # =========================================================================
    # Display Completion Message
    # =========================================================================
    - name: Build completion message
      ansible.builtin.set_fact:
        completion_message: |
          ========================================
          ‚úÖ ArgoCD Installation Complete!
          ========================================

          üìä Pods Status:
          {{ argocd_pods.stdout }}

          üîó Services:
          {{ argocd_svc.stdout }}

          üåê IngressRoute:
          {{ argocd_ingressroute.stdout | default('SKIPPED - Traefik/cert-manager CRDs not installed') if ingress_crds_available | default(false) else '‚è≠Ô∏è  SKIPPED - Run again after Traefik/cert-manager install' }}

          üîê Certificate:
          {{ argocd_cert.stdout | default('Not found') if ingress_crds_available | default(false) else '‚è≠Ô∏è  SKIPPED - Run again after cert-manager install' }}

          üîë OIDC Secret:
          {{ '‚úÖ Applied' if (argocd_oidc_sealed.stat.exists and sealedsecrets_crd_available | default(false)) else '‚è≠Ô∏è  SKIPPED - Run again after sealed-secrets install' if argocd_oidc_sealed.stat.exists else 'Not configured (no sealed secret file)' }}

          üîí TLS Trust (Staging CA):
          {{ '‚úÖ Configured - ArgoCD trusts LE staging CA for ' + authelia_oidc_domain if use_staging_certs else '‚è≠Ô∏è  Not needed - using production certificates' }}

          üì¶ Repository Connection:
          {{ 'Configured: ' + argocd_github_repo_url if github_repo_configured else 'Not configured (no GitHub URL/token provided)' }}

          ========================================
          üìù Access Information:
          ========================================
          URL:      https://{{ argocd_domain }}
          Username: admin
          Password: (configured via Terraform)

          ========================================
          üîß CLI Access:
          ========================================
          # Install ArgoCD CLI (if not installed):
          brew install argocd  # macOS

          # Login:
          argocd login {{ argocd_domain }} --username admin

          ========================================
          üìö Quick Start:
          ========================================
          # Verify repository connection:
          argocd repo list

          # List applications:
          argocd app list

          # Create an application from your repo:
          argocd app create my-app \
            --repo {{ argocd_github_repo_url if github_repo_configured else 'https://github.com/your-org/repo.git' }} \
            --path kubernetes/manifests \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace default \
            --sync-policy automated

          # Manual sync:
          argocd app sync my-app

          ========================================

    - name: Display completion message
      ansible.builtin.debug:
        msg: "{{ completion_message.split('\n') }}"

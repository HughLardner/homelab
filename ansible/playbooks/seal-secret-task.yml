---
# Task file for sealing individual secrets
# Included by seal-secrets.yml

- name: Set default scope
  ansible.builtin.set_fact:
    secret_scope: "{{ secret.scope | default('strict') }}"

- name: Validate secret scope
  ansible.builtin.fail:
    msg: "Invalid scope '{{ secret_scope }}'. Must be one of: strict, namespace-wide, cluster-wide"
  when: secret_scope not in ['strict', 'namespace-wide', 'cluster-wide']

- name: Display secret info
  ansible.builtin.debug:
    msg: "Sealing {{ secret.name }} in {{ secret.namespace }} (scope: {{ secret_scope }})"

- name: Create output directory
  ansible.builtin.file:
    path: "{{ project_root }}/{{ secret.output_path | dirname }}"
    state: directory
    mode: '0755'

- name: Create temporary secret manifest file
  ansible.builtin.copy:
    content: "{{ lookup('template', 'secret-manifest.j2') }}"
    dest: "{{ temp_dir.path }}/{{ secret.name }}-plain.yaml"
    mode: '0600'
  vars:
    secret_name: "{{ secret.name }}"
    secret_namespace: "{{ secret.namespace }}"
    secret_type: "{{ secret.type | default('Opaque') }}"
    secret_data: "{{ secret.data }}"

- name: Seal secret with kubeseal
  ansible.builtin.shell: |
    set -e
    set -o pipefail

    # Generate the secret and pipe to kubeseal
    case "{{ secret.type | default('Opaque') }}" in
      "Opaque")
        # For Opaque secrets, use --from-literal for each key
        SECRET_ARGS=""
        {% for key, value in secret.data.items() %}
        SECRET_ARGS="$SECRET_ARGS --from-literal='{{ key }}={{ value | replace("'", "'\\''") }}'"
        {% endfor %}

        kubectl create secret generic "{{ secret.name }}" \
          --namespace="{{ secret.namespace }}" \
          $SECRET_ARGS \
          --dry-run=client -o yaml \
          | kubeseal --scope {{ secret_scope }} -o yaml \
          > "{{ project_root }}/{{ secret.output_path }}"
        ;;

      "kubernetes.io/tls")
        # For TLS secrets, write cert and key to temp files
        echo '{{ secret.data["tls.crt"] }}' > "{{ temp_dir.path }}/tls.crt"
        echo '{{ secret.data["tls.key"] }}' > "{{ temp_dir.path }}/tls.key"

        kubectl create secret tls "{{ secret.name }}" \
          --namespace="{{ secret.namespace }}" \
          --cert="{{ temp_dir.path }}/tls.crt" \
          --key="{{ temp_dir.path }}/tls.key" \
          --dry-run=client -o yaml \
          | kubeseal --scope {{ secret_scope }} -o yaml \
          > "{{ project_root }}/{{ secret.output_path }}"

        rm -f "{{ temp_dir.path }}/tls.crt" "{{ temp_dir.path }}/tls.key"
        ;;

      "kubernetes.io/dockerconfigjson")
        # For docker config, write to temp file
        echo '{{ secret.data[".dockerconfigjson"] }}' > "{{ temp_dir.path }}/.dockerconfigjson"

        kubectl create secret docker-registry "{{ secret.name }}" \
          --namespace="{{ secret.namespace }}" \
          --from-file=.dockerconfigjson="{{ temp_dir.path }}/.dockerconfigjson" \
          --dry-run=client -o yaml \
          | kubeseal --scope {{ secret_scope }} -o yaml \
          > "{{ project_root }}/{{ secret.output_path }}"

        rm -f "{{ temp_dir.path }}/.dockerconfigjson"
        ;;

      *)
        # For other secret types, use generic with from-literal
        SECRET_ARGS=""
        {% for key, value in secret.data.items() %}
        SECRET_ARGS="$SECRET_ARGS --from-literal='{{ key }}={{ value | replace("'", "'\\''") }}'"
        {% endfor %}

        kubectl create secret generic "{{ secret.name }}" \
          --namespace="{{ secret.namespace }}" \
          --type="{{ secret.type }}" \
          $SECRET_ARGS \
          --dry-run=client -o yaml \
          | kubeseal --scope {{ secret_scope }} -o yaml \
          > "{{ project_root }}/{{ secret.output_path }}"
        ;;
    esac
  args:
    executable: /bin/bash
  register: kubeseal_result
  changed_when: true

- name: Add header comment to sealed secret
  ansible.builtin.lineinfile:
    path: "{{ project_root }}/{{ secret.output_path }}"
    insertbefore: BOF
    line: |
      # Sealed Secret: {{ secret.name }}
      # Namespace: {{ secret.namespace }}
      # Scope: {{ secret_scope }}
      # Generated: {{ ansible_date_time.iso8601 }}
      # DO NOT EDIT - This file is auto-generated by seal-secrets.yml
    state: present

- name: Display sealed secret path
  ansible.builtin.debug:
    msg: "âœ“ Sealed secret written to {{ secret.output_path }}"

---
# Task file for sealing individual secrets
# Included by seal-secrets.yml

- name: Set default scope and type
  ansible.builtin.set_fact:
    secret_scope: "{{ secret.scope | default('strict') }}"
    secret_type: "{{ secret.type | default('Opaque') }}"

- name: Validate secret scope
  ansible.builtin.fail:
    msg: "Invalid scope '{{ secret_scope }}'. Must be one of: strict, namespace-wide, cluster-wide"
  when: secret_scope not in ['strict', 'namespace-wide', 'cluster-wide']

- name: Display secret info
  ansible.builtin.debug:
    msg: "Sealing {{ secret.name }} in {{ secret.namespace }} (type: {{ secret_type }}, scope: {{ secret_scope }})"

- name: Create output directory
  ansible.builtin.file:
    path: "{{ project_root }}/{{ secret.output_path | dirname }}"
    state: directory
    mode: '0755'

# Build --from-literal arguments for Opaque secrets
- name: Build secret arguments
  ansible.builtin.set_fact:
    secret_args: "{{ secret_args | default([]) + ['--from-literal=' + item.key + '=' + item.value] }}"
  loop: "{{ secret.data | dict2items }}"
  when: secret_type in ["Opaque", ""] or (secret_type not in ["kubernetes.io/tls", "kubernetes.io/dockerconfigjson"])

# Opaque secrets
- name: Seal Opaque secret
  ansible.builtin.shell:
    cmd: |
      kubectl create secret generic "{{ secret.name }}" \
        --namespace="{{ secret.namespace }}" \
        {{ secret_args | join(' ') }} \
        --dry-run=client -o yaml \
        | kubeseal --scope {{ secret_scope }} -o yaml \
        > "{{ project_root }}/{{ secret.output_path }}"
  when: secret_type == "Opaque"
  register: kubeseal_result
  changed_when: true

# TLS secrets
- name: Write TLS certificate to temp file
  ansible.builtin.copy:
    content: "{{ secret.data['tls.crt'] }}"
    dest: "{{ temp_dir.path }}/tls.crt"
    mode: '0600'
  when: secret_type == "kubernetes.io/tls"

- name: Write TLS key to temp file
  ansible.builtin.copy:
    content: "{{ secret.data['tls.key'] }}"
    dest: "{{ temp_dir.path }}/tls.key"
    mode: '0600'
  when: secret_type == "kubernetes.io/tls"

- name: Seal TLS secret
  ansible.builtin.shell:
    cmd: |
      kubectl create secret tls "{{ secret.name }}" \
        --namespace="{{ secret.namespace }}" \
        --cert="{{ temp_dir.path }}/tls.crt" \
        --key="{{ temp_dir.path }}/tls.key" \
        --dry-run=client -o yaml \
        | kubeseal --scope {{ secret_scope }} -o yaml \
        > "{{ project_root }}/{{ secret.output_path }}"
  when: secret_type == "kubernetes.io/tls"
  register: kubeseal_result
  changed_when: true

- name: Cleanup TLS temp files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ temp_dir.path }}/tls.crt"
    - "{{ temp_dir.path }}/tls.key"
  when: secret_type == "kubernetes.io/tls"

# Docker registry secrets
- name: Write dockerconfigjson to temp file
  ansible.builtin.copy:
    content: "{{ secret.data['.dockerconfigjson'] }}"
    dest: "{{ temp_dir.path }}/.dockerconfigjson"
    mode: '0600'
  when: secret_type == "kubernetes.io/dockerconfigjson"

- name: Seal docker registry secret
  ansible.builtin.shell:
    cmd: |
      kubectl create secret docker-registry "{{ secret.name }}" \
        --namespace="{{ secret.namespace }}" \
        --from-file=.dockerconfigjson="{{ temp_dir.path }}/.dockerconfigjson" \
        --dry-run=client -o yaml \
        | kubeseal --scope {{ secret_scope }} -o yaml \
        > "{{ project_root }}/{{ secret.output_path }}"
  when: secret_type == "kubernetes.io/dockerconfigjson"
  register: kubeseal_result
  changed_when: true

- name: Cleanup dockerconfigjson temp file
  ansible.builtin.file:
    path: "{{ temp_dir.path }}/.dockerconfigjson"
    state: absent
  when: secret_type == "kubernetes.io/dockerconfigjson"

# Other secret types (generic with custom type)
- name: Seal generic secret with custom type
  ansible.builtin.shell:
    cmd: |
      kubectl create secret generic "{{ secret.name }}" \
        --namespace="{{ secret.namespace }}" \
        --type="{{ secret_type }}" \
        {{ secret_args | join(' ') }} \
        --dry-run=client -o yaml \
        | kubeseal --scope {{ secret_scope }} -o yaml \
        > "{{ project_root }}/{{ secret.output_path }}"
  when: secret_type not in ["Opaque", "kubernetes.io/tls", "kubernetes.io/dockerconfigjson"]
  register: kubeseal_result
  changed_when: true

- name: Add header comment to sealed secret
  ansible.builtin.lineinfile:
    path: "{{ project_root }}/{{ secret.output_path }}"
    insertbefore: BOF
    line: |
      # Sealed Secret: {{ secret.name }}
      # Namespace: {{ secret.namespace }}
      # Type: {{ secret_type }}
      # Scope: {{ secret_scope }}
      # Generated: {{ ansible_date_time.iso8601 }}
      # DO NOT EDIT - This file is auto-generated by seal-secrets.yml
    state: present

- name: Display sealed secret path
  ansible.builtin.debug:
    msg: "âœ“ Sealed secret written to {{ secret.output_path }}"

- name: Clear secret_args for next iteration
  ansible.builtin.set_fact:
    secret_args: []

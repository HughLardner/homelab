---
# Seal Secrets Playbook
# Encrypts plain secrets from secrets.yml and commits to git
#
# Usage: ansible-playbook ansible/playbooks/seal-secrets.yml
# Or:    make seal-secrets

- name: Seal Secrets for GitOps
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    secrets_file: "{{ playbook_dir }}/../../secrets.yml"
    project_root: "{{ playbook_dir }}/../.."
    git_commit_message: "Update sealed secrets"
    git_auto_push: false  # Set to true to automatically push to remote

  pre_tasks:
    - name: Check if secrets.yml exists
      ansible.builtin.stat:
        path: "{{ secrets_file }}"
      register: secrets_file_stat

    - name: Fail if secrets.yml doesn't exist
      ansible.builtin.fail:
        msg: |
          secrets.yml not found!

          Please create it from the template:
            cp secrets.example.yml secrets.yml

          Then fill in your secret values and run this playbook again.
      when: not secrets_file_stat.stat.exists

    - name: Check if kubeseal CLI is installed
      ansible.builtin.command: which kubeseal
      register: kubeseal_check
      changed_when: false
      failed_when: false

    - name: Fail if kubeseal is not installed
      ansible.builtin.fail:
        msg: |
          kubeseal CLI is not installed!

          Install it with:
            macOS:  brew install kubeseal
            Linux:  See kubernetes/services/sealed-secrets/README.md
      when: kubeseal_check.rc != 0

    - name: Check if kubectl is configured
      ansible.builtin.command: kubectl cluster-info
      register: kubectl_check
      changed_when: false
      failed_when: false

    - name: Fail if kubectl is not configured
      ansible.builtin.fail:
        msg: |
          kubectl is not configured or cluster is not accessible!

          Make sure KUBECONFIG is set and cluster is running:
            export KUBECONFIG=~/.kube/config-homelab
            kubectl get nodes
      when: kubectl_check.rc != 0

    - name: Load secrets from file
      ansible.builtin.include_vars:
        file: "{{ secrets_file }}"
        name: secrets_config

    - name: Validate secrets configuration
      ansible.builtin.fail:
        msg: "No secrets defined in {{ secrets_file }}"
      when: secrets_config.secrets is not defined or secrets_config.secrets | length == 0

  tasks:
    - name: Display secrets to be processed
      ansible.builtin.debug:
        msg: "Processing {{ secrets_config.secrets | length }} secret(s)"

    - name: Create temporary directory for secret generation
      ansible.builtin.tempfile:
        state: directory
        prefix: sealed-secrets-
      register: temp_dir

    - name: Process each secret
      ansible.builtin.include_tasks: seal-secret-task.yml
      loop: "{{ secrets_config.secrets }}"
      loop_control:
        loop_var: secret
        label: "{{ secret.name }} ({{ secret.namespace }})"

    - name: Cleanup temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent

    - name: Check for changes in git
      ansible.builtin.command:
        cmd: git status --porcelain
        chdir: "{{ project_root }}"
      register: git_status
      changed_when: false

    - name: Display git status
      ansible.builtin.debug:
        msg: "{{ git_status.stdout_lines }}"
      when: git_status.stdout != ""

    - name: Git add sealed secrets
      ansible.builtin.command:
        cmd: git add kubernetes/
        chdir: "{{ project_root }}"
      when: git_status.stdout != ""
      register: git_add_result
      changed_when: true

    - name: Git commit sealed secrets
      ansible.builtin.command:
        cmd: git commit -m "{{ git_commit_message }}"
        chdir: "{{ project_root }}"
      when: git_status.stdout != ""
      register: git_commit_result
      changed_when: "'nothing to commit' not in git_commit_result.stdout"
      failed_when: false

    - name: Git push to remote
      ansible.builtin.command:
        cmd: git push
        chdir: "{{ project_root }}"
      when:
        - git_auto_push | bool
        - git_commit_result is changed
      register: git_push_result
      changed_when: true

  post_tasks:
    - name: Build completion message
      ansible.builtin.set_fact:
        completion_message: |

          ==========================================
          ✅ Sealed Secrets Processing Complete!
          ==========================================

          Processed: {{ secrets_config.secrets | length }} secret(s)
          {% if git_status.stdout != "" %}

          Git Status:
          {% for line in git_status.stdout_lines %}
            {{ line }}
          {% endfor %}

          {% if git_commit_result is changed %}
          ✓ Changes committed to git
          {% endif %}
          {% if git_push_result is changed %}
          ✓ Changes pushed to remote
          {% elif git_auto_push | bool %}
          ⚠ Auto-push enabled but no changes to push
          {% else %}
          ⚠ Changes committed but not pushed (set git_auto_push=true to auto-push)

          To push manually:
            git push
          {% endif %}
          {% else %}
          ℹ No changes detected (sealed secrets are up to date)
          {% endif %}

          Next Steps:
          1. Verify sealed secrets in kubernetes/ directory
          2. Apply via ArgoCD or kubectl:
             kubectl apply -f <sealed-secret-file>
          3. Verify secret was created:
             kubectl get secret <secret-name> -n <namespace>

          ==========================================

    - name: Display completion message
      ansible.builtin.debug:
        msg: "{{ completion_message.split('\n') }}"

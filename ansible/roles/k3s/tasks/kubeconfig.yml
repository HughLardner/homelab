---
# Kubeconfig Management Tasks
# Handles kubeconfig retrieval and local configuration

- name: Read kubeconfig from first master node
  ansible.builtin.slurp:
    src: "{{ k3s_kubeconfig_path }}"
  delegate_to: "{{ k3s_first_master }}"
  register: kubeconfig_content
  run_once: true
  when: is_first_master

- name: Get home directory for localhost
  ansible.builtin.set_fact:
    local_home: "{{ lookup('env', 'HOME') }}"
  run_once: true
  when: is_first_master

- name: Ensure ~/.kube directory exists
  ansible.builtin.file:
    path: "{{ local_home }}/.kube"
    state: directory
    mode: '0700'
  delegate_to: localhost
  connection: local
  become: false
  run_once: true
  when: is_first_master

- name: Get first master IP for kubeconfig
  ansible.builtin.set_fact:
    k3s_server_ip: "{{ hostvars[k3s_first_master]['ansible_host'] | default(hostvars[k3s_first_master]['ansible_default_ipv4']['address']) }}"
  run_once: true
  when: is_first_master

- name: Decode and save kubeconfig locally
  ansible.builtin.copy:
    content: "{{ kubeconfig_content.content | b64decode | regex_replace('127\\.0\\.0\\.1', k3s_server_ip) }}"
    dest: "{{ local_home }}/.kube/{{ k3s_local_kubeconfig_name }}"
    mode: '0600'
  delegate_to: localhost
  connection: local
  become: false
  run_once: true
  when: is_first_master
  no_log: true  # Kubeconfig contains sensitive data

- name: Display kubeconfig location
  ansible.builtin.debug:
    msg:
      - "Kubeconfig saved to: {{ local_home }}/.kube/{{ k3s_local_kubeconfig_name }}"
      - "Server URL updated to: {{ k3s_first_master_ip }}"
  run_once: true
  when: is_first_master

